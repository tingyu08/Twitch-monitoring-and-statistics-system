# Story 2.4: Twitch API 整合增強 (Twurple)

## 狀態 (Status)

- ✅ 已完成 (Completed)
- 建立日期：2025-12-15
- 最後更新：2025-12-15

## 用戶故事 (Story)

**作為** 系統開發者  
**我想要** 使用 Twurple 整合更完整的 Twitch API 功能  
**以便於** 提供更豐富的數據查詢與功能支援，並獲得更好的類型安全和維護性

## 技術決策

### 為什麼選擇 Twurple？

| 特性           | 之前 (tmi.js + axios) | 之後 (Twurple)           |
| -------------- | --------------------- | ------------------------ |
| **類型安全**   | 需要自建類型          | 內建完整 TypeScript 類型 |
| **Token 管理** | 需要自建邏輯          | 內建自動刷新             |
| **API 覆蓋**   | 手動封裝              | 100% Helix API 覆蓋      |
| **維護狀態**   | tmi.js v1 停滯        | 活躍更新                 |
| **統一性**     | 多個庫                | 單一生態系               |

### 技術分工

| 技術            | 用途                              |
| --------------- | --------------------------------- |
| `@twurple/api`  | Twitch Helix API                  |
| `@twurple/auth` | OAuth Token 管理                  |
| `@twurple/chat` | 聊天室監聽                        |
| `DecAPI`        | followage、accountAge（獨特功能） |
| `Axios`         | 非 Twitch HTTP 請求               |

## 已完成工作

### 1. 安裝 Twurple 套件

```bash
npm install @twurple/api @twurple/auth @twurple/chat
npm uninstall tmi.js @types/tmi.js
```

### 2. 服務層重構

| 服務                        | 狀態 | 說明               |
| --------------------------- | ---- | ------------------ |
| `twurple-auth.service.ts`   | 新增 | Token 管理         |
| `twitch-helix.service.ts`   | 重寫 | 使用 @twurple/api  |
| `twitch-chat.service.ts`    | 重寫 | 使用 @twurple/chat |
| `unified-twitch.service.ts` | 更新 | 整合 Twurple       |
| `decapi.service.ts`         | 精簡 | 只保留獨特功能     |
| `message-parser.ts`         | 更新 | 移除 tmi.js 依賴   |

### 3. 文件更新

- 建立 `docs/backend-tech-stack.md` 技術棧指南

## API 端點

| 端點                                        | 功能          |
| ------------------------------------------- | ------------- |
| `GET /api/twitch/channel/:login`            | 頻道資訊      |
| `POST /api/twitch/channels`                 | 批量頻道資訊  |
| `GET /api/twitch/followage/:channel/:user`  | 追蹤時長      |
| `GET /api/twitch/relation/:channel/:viewer` | 觀眾-頻道關係 |
| `POST /api/twitch/live-status`              | 直播狀態      |
| `GET /api/twitch/status`                    | 服務狀態      |

## 依賴變更

### 新增

- `@twurple/api` ^8.0.2
- `@twurple/auth` ^8.0.2
- `@twurple/chat` ^8.0.2

### 移除

- `tmi.js`
- `@types/tmi.js`

### 保留

- `axios` - 用於 DecAPI 和 Proxy 功能

## 完成定義 (Definition of Done)

- [x] Twurple 套件安裝完成
- [x] tmi.js 依賴移除
- [x] Auth 服務建立
- [x] Helix 服務重寫
- [x] Chat 服務重寫
- [x] DecAPI 服務精簡
- [x] Message Parser 更新
- [x] TypeScript 編譯成功
- [x] API 端點保持相容
- [x] 技術棧文件建立

## 相關文件

- [後端技術棧指南](../backend-tech-stack.md)
