# Story 2.2: è§€çœ¾è§€çœ‹æ™‚æ•¸èˆ‡äº’å‹•çµ±è¨ˆåœ–è¡¨

## Status

- ğŸ“‹ Draft
- å»ºç«‹æ—¥æœŸï¼š2025-12-11
- ä¾è³´ï¼šStory 2.1ï¼ˆè§€çœ¾ç™»å…¥èˆ‡æˆæ¬Šï¼‰

## Related Documents

- `docs/epic-2-viewer-engagement-analytics.md#4-user-stories` â€“ Story 2.2 åŸå§‹éœ€æ±‚èƒŒæ™¯
- `docs/stories/2.1.viewer-login-and-authorization.md` â€“ å‰ç½®æ•…äº‹
- `docs/architecture/fullstack-architecture.md` â€“ æŠ€è¡“æ¶æ§‹åƒè€ƒ
- `docs/risk-and-nfr-summary.md` â€“ æ€§èƒ½èˆ‡å®‰å…¨éœ€æ±‚

## Story

**As a** é‡åº¦è§€çœ¾ï¼ˆè¿½è¹¤æŸä½å¯¦æ³ä¸»ï¼‰  
**I want** æŸ¥çœ‹è‡ªå·±åœ¨æŸä½å¯¦æ³ä¸»é »é“çš„è§€çœ‹æ™‚æ•¸çµ±è¨ˆèˆ‡è¶¨å‹¢åœ–è¡¨  
**so that** æˆ‘èƒ½é‡åŒ–ä¸¦è¦–è¦ºåŒ–è‡ªå·±å°è©²å¯¦æ³ä¸»çš„é•·æœŸæ”¯æŒç¨‹åº¦ã€‚

## Acceptance Criteria

### AC 1: é »é“è§€çœ‹æ™‚æ•¸å±•ç¤ºå¡ç‰‡
- Given è§€çœ¾å·²ç™»å…¥ä¸”é€²å…¥é »é“çµ±è¨ˆé é¢
- When é é¢åŠ è¼‰å®Œæˆ
- Then ç³»çµ±æ‡‰åœ¨å¡ç‰‡ä¸­é¡¯ç¤ºï¼š
  - ã€Œç´¯ç©è§€çœ‹æ™‚æ•¸ã€ï¼ˆæ™‚:åˆ† æ ¼å¼ï¼Œå¦‚ 156:42ï¼‰
  - ã€Œå¹³å‡æ¯æ¬¡è§€çœ‹æ™‚é•·ã€ï¼ˆåˆ†é˜ï¼‰
  - ã€Œè§€çœ‹æ¬¡æ•¸ã€ï¼ˆå…± N æ¬¡ï¼‰
  - ã€Œæœ€å¾Œè§€çœ‹æ—¥æœŸã€ï¼ˆç›¸å°æ™‚é–“ï¼Œå¦‚ã€Œ2 å¤©å‰ã€ï¼‰
- And å¡ç‰‡é ‚éƒ¨é¡¯ç¤ºæ‰€æŸ¥è©¢çš„æ™‚é–“ç¯„åœï¼ˆå¦‚ã€Œéå» 7 å¤©ã€æˆ–ã€Œè‡ª 2025-11-01 åˆ° 2025-12-11ã€ï¼‰

### AC 2: æ™‚é–“ç¯„åœé¸æ“‡å™¨ï¼ˆé è¨­ + è‡ªè¨‚ï¼‰
- Given è§€çœ¾åœ¨è§€çœ‹çµ±è¨ˆå¡ç‰‡ä¸Šæ–¹
- When è§€çœ¾å¯è¦‹é¸æ“‡å™¨å€åŸŸ
- Then ç³»çµ±æ‡‰æä¾›ï¼š
  - **å¿«é€ŸæŒ‰éˆ•**ï¼šã€Œ7 å¤©ã€ã€ã€Œ30 å¤©ã€ã€ã€Œ90 å¤©ã€ã€ã€Œå…¨éƒ¨ã€
  - **è‡ªè¨‚æ—¥æœŸé¸æ“‡å™¨**ï¼ˆDate Range Pickerï¼‰ï¼šå¯é¸ã€Œé–‹å§‹æ—¥æœŸã€èˆ‡ã€ŒçµæŸæ—¥æœŸã€
  - ç•¶å‰é¸ä¸­ç¯„åœæ‡‰æœ‰è¦–è¦ºé«˜äº®ï¼ˆå¦‚èƒŒæ™¯è‰²æˆ–ç²—é«”ï¼‰
- And é»æ“Šä»»ä½•é¸é …å¾Œï¼Œç«‹å³é‡æ–°æŸ¥è©¢è³‡æ–™ä¸¦æ›´æ–°åœ–è¡¨ï¼ˆä¸éœ€é¡å¤–ç¢ºèªæŒ‰éˆ•ï¼‰
- And è‡ªè¨‚æ—¥æœŸè‹¥è¶…éè³‡æ–™ç¯„åœï¼Œæ‡‰é¡¯ç¤ºè­¦å‘Šè¨Šæ¯ï¼ˆå¦‚ã€Œéƒ¨åˆ†æ—¥æœŸæš«ç„¡è³‡æ–™ã€ï¼‰

### AC 3: æ¯æ—¥è§€çœ‹è¶¨å‹¢æŠ˜ç·šåœ–
- Given æ™‚é–“ç¯„åœå·²ç¢ºå®š
- When ç³»çµ±å·²èšåˆè©²ç¯„åœå…§çš„æ¯æ—¥è§€çœ‹æ™‚æ•¸
- Then ç³»çµ±æ‡‰é¡¯ç¤º Recharts LineChartï¼š
  - **X è»¸**ï¼šæ—¥æœŸï¼ˆæ ¼å¼ MMM DDï¼Œå¦‚ Nov 28ï¼‰
  - **Y è»¸**ï¼šç´¯ç©è§€çœ‹æ™‚æ•¸ï¼ˆåˆ†é˜ï¼‰
  - **æŠ˜ç·š**ï¼šæ—¥å‡è§€çœ‹æ™‚æ•¸ï¼ˆåˆ†é˜/å¤©ï¼‰
  - **åœ–è¡¨äº’å‹•**ï¼šæ»‘é¼ æ‡¸åœé¡¯ç¤º Tooltipï¼ˆæ—¥æœŸã€æ™‚æ•¸ã€æ¬¡æ•¸ï¼‰
  - **éŸ¿æ‡‰å¼**ï¼šæ‰‹æ©Ÿä¸Šè‡ªå‹•èª¿æ•´å­—é«”å¤§å°èˆ‡ä½ˆå±€

### AC 4: è³‡æ–™èšåˆ APIï¼ˆå¾Œç«¯ï¼‰
- Given å‰ç«¯ç™¼é€æ—¥æœŸç¯„åœæŸ¥è©¢è«‹æ±‚
- When å¾Œç«¯æ”¶åˆ° `GET /api/viewer/{viewerId}/channels/{channelId}/watch-stats?startDate=YYYY-MM-DD&endDate=YYYY-MM-DD`
- Then ç³»çµ±æ‡‰è¿”å›ï¼š
  ```json
  {
    "channelId": "string",
    "channelName": "string",
    "timeRange": {
      "startDate": "2025-11-12",
      "endDate": "2025-12-11"
    },
    "summary": {
      "totalWatchTimeMinutes": 156,
      "totalSessions": 12,
      "avgSessionMinutes": 13,
      "lastWatchedAt": "2025-12-10T14:30:00Z"
    },
    "dailyBreakdown": [
      {
        "date": "2025-11-12",
        "watchTimeMinutes": 45,
        "sessionCount": 3
      },
      // ... æ¯æ—¥è³‡æ–™
    ]
  }
  ```
- And è‹¥æ—¥æœŸç¯„åœè¶…éè©²è§€çœ¾çš„çµ±è¨ˆèµ·é»ï¼Œæ‡‰è‡ªå‹•æˆªæ–·è‡³æœ€æ—©è¨˜éŒ„æ—¥æœŸ
- And è‹¥ç„¡è©²ç¯„åœè³‡æ–™ï¼Œè¿”å›ç©ºé™£åˆ—ä½†ä¸å ±éŒ¯

### AC 5: ç‰©åŒ–è¦–åœ–ï¼ˆMaterialized Viewï¼‰èšåˆ
- Given è§€çœ¾è³‡æ–™ç¶“ç”± EventSub æŒçºŒå¯«å…¥ `ViewerChannelDailyStat` è¡¨
- When ä½¿ç”¨è€…æŸ¥è©¢æ—¥æœŸç¯„åœæ™‚
- Then ç³»çµ±æ‡‰ä½¿ç”¨é å…ˆèšåˆçš„ç‰©åŒ–è¦–åœ– `ViewerChannelDailyAgg` å¿«é€Ÿå›æ‡‰ï¼š
  - è¦–åœ–æ‡‰æŒ‰ (viewerId, channelId, date) åˆ†çµ„
  - å„²å­˜ totalWatchTimeMinutes, sessionCount, lastWatchedAt
  - è¦–åœ–æ‡‰æ¯å°æ™‚æˆ–æ¯å¤©åˆ·æ–°ä¸€æ¬¡ï¼ˆå®šæ™‚ä»»å‹™ï¼‰
  - æŸ¥è©¢æ™‚é–“æ‡‰ < 100msï¼ˆæ¸¬è©¦ç›®æ¨™ï¼‰

### AC 6: èª¤å·®è™•ç†èˆ‡è³‡æ–™é©—è­‰
- Given å‰ç«¯è«‹æ±‚ç„¡æ•ˆçš„æ—¥æœŸç¯„åœ
- When å¦‚ startDate > endDate æˆ–æ—¥æœŸæ ¼å¼éŒ¯èª¤
- Then ç³»çµ±æ‡‰è¿”å› HTTP 400 èˆ‡æ˜ç¢ºçš„éŒ¯èª¤è¨Šæ¯
- And å‰ç«¯æ‡‰æ•æ‰éŒ¯èª¤ä¸¦é¡¯ç¤ºå‹å–„çš„ä½¿ç”¨è€…æç¤ºï¼ˆä¸é¡¯ç¤ºæŠ€è¡“ç´°ç¯€ï¼‰

### AC 7: éš±ç§èˆ‡æˆæ¬Šæª¢æŸ¥
- Given è§€çœ¾ A å˜—è©¦æŸ¥è©¢å…¶ä»–è§€çœ¾ B çš„è³‡æ–™
- When è«‹æ±‚æœªç¬¦åˆè©²è§€çœ¾èº«åˆ†
- Then ç³»çµ±æ‡‰è¿”å› HTTP 403 Forbidden
- And æ—¥èªŒæ‡‰è¨˜éŒ„æ­¤æœªæˆæ¬Šå­˜å–å˜—è©¦

---

## Tasks / Subtasks

### Task 1ï¼ˆAC 4, 5ï¼‰å¾Œç«¯ï¼šç‰©åŒ–è¦–åœ–èˆ‡èšåˆ API

- [ ] Task 1.1: å»ºç«‹ Prisma Migration â€“ ç‰©åŒ–è¦–åœ–è¡¨
  - [x] æ–°å¢ `ViewerChannelDailyAgg` è¡¨çµæ§‹ï¼š
    ```sql
    CREATE TABLE ViewerChannelDailyAgg (
      id: String @id @default(cuid())
      viewerId: String
      channelId: String
      date: DateTime @db.Date
      totalWatchTimeMinutes: Int
      sessionCount: Int
      lastWatchedAt: DateTime
      createdAt: DateTime @default(now())
      updatedAt: DateTime @updatedAt
      
      @@unique([viewerId, channelId, date])
      @@index([viewerId])
      @@index([channelId])
    }
    ```
  - [x] åŸ·è¡Œ `prisma migrate dev --name add_viewer_daily_agg`

- [ ] Task 1.2: å»ºç«‹ Materialized View åˆ·æ–°å‡½æ•¸
  - [x] æ–°å¢ `src/services/aggregation.service.ts`
  - [x] å¯¦ä½œ `refreshViewerChannelDailyAgg()` æ–¹æ³•ï¼š
    - æŸ¥è©¢ `ViewerChannelDailyStat`ï¼ˆå¦‚æœå­˜åœ¨ï¼‰æˆ– EventSub logs
    - æŒ‰ (viewerId, channelId, date) åˆ†çµ„ï¼Œè¨ˆç®— sum(watchTimeMinutes), count(sessions)
    - Upsert è‡³ `ViewerChannelDailyAgg`
    - è¿”å›æ›´æ–°ç­†æ•¸
  - [x] é‚è¼¯æ‡‰å†ªç­‰ï¼ˆé‡è¤‡åŸ·è¡Œä¸æœƒç”¢ç”Ÿé‡è¤‡è³‡æ–™ï¼‰

- [ ] Task 1.3: è¨­å®šå®šæ™‚åˆ·æ–°ä»»å‹™
  - [x] æ–°å¢ Cron Jobï¼ˆå¦‚ä½¿ç”¨ node-cron æˆ– Bull Queueï¼‰
  - [x] æ¯å°æ™‚åŸ·è¡Œ `refreshViewerChannelDailyAgg()`
  - [x] è¨˜éŒ„åŸ·è¡Œæ™‚é–“èˆ‡æˆåŠŸ/å¤±æ•—ç‹€æ…‹æ–¼æ—¥èªŒ

- [ ] Task 1.4: å»ºç«‹èšåˆæŸ¥è©¢ API ç«¯é»
  - [x] æ–°å¢ `src/modules/viewer/viewer-stats.controller.ts`
  - [x] å¯¦ä½œ `GET /api/viewer/:viewerId/channels/:channelId/watch-stats`
    ```typescript
    // åƒæ•¸é©—è­‰
    startDate?: string (YYYY-MM-DD) // é è¨­éå» 7 å¤©
    endDate?: string (YYYY-MM-DD)   // é è¨­ä»Šå¤©
    ```
  - [x] æŸ¥è©¢ `ViewerChannelDailyAgg` è¡¨ï¼Œç¯©é¸æ—¥æœŸç¯„åœ
  - [x] è¨ˆç®— summaryï¼ˆtotalWatchTime, totalSessions, avgSessionMinutes, lastWatchedï¼‰
  - [x] è¿”å›æ ¼å¼å¦‚ AC 4 æ‰€ç¤º

- [ ] Task 1.5: å¯¦ä½œèº«ä»½é©—è­‰èˆ‡æˆæ¬Šæª¢æŸ¥
  - [x] é©—è­‰è«‹æ±‚è€…çš„ JWT Token
  - [x] ç¢ºèª `viewerId` ç¬¦åˆ Token ä¸­çš„ twitchUserId
  - [x] è‹¥ä¸ç¬¦ï¼Œè¿”å› 403 Forbidden

- [ ] Task 1.6: æ¸¬è©¦èšåˆé‚è¼¯
  - [x] Mock 100 ç­† ViewerChannelDailyStat è¨˜éŒ„
  - [x] é©—è­‰ refresh å‡½æ•¸æ­£ç¢ºè¨ˆç®— sum & count
  - [x] é©—è­‰æŸ¥è©¢çµæœèˆ‡é æœŸç›¸ç¬¦

### Task 2ï¼ˆAC 2ï¼‰å‰ç«¯ï¼šæ™‚é–“ç¯„åœé¸æ“‡å™¨

- [ ] Task 2.1: å®‰è£ & é…ç½®æ—¥æœŸé¸æ“‡å™¨åº«
  - [x] æ±ºå®šåº«é¸æ“‡ï¼ˆæ¨è–¦ `react-day-picker` + `date-fns` æˆ– `@headlessui/react`ï¼‰
  - [x] æ–°å¢è‡³ `frontend/package.json`
  - [x] åŸ·è¡Œ `npm install`

- [ ] Task 2.2: å»ºç«‹æ™‚é–“ç¯„åœé¸æ“‡å™¨å…ƒä»¶
  - [x] æ–°å¢ `src/features/viewer-dashboard/components/TimeRangeSelector.tsx`
  - [x] åŠŸèƒ½ï¼š
    - é¡¯ç¤º 4 å€‹å¿«é€ŸæŒ‰éˆ•ï¼šã€Œ7 å¤©ã€ã€ã€Œ30 å¤©ã€ã€ã€Œ90 å¤©ã€ã€ã€Œå…¨éƒ¨ã€
    - é¡¯ç¤º Date Range Pickerï¼ˆå±•é–‹/æŠ˜ç–Šå¼ï¼‰
    - ç•¶å‰é¸ä¸­ç¯„åœé«˜äº®
    - é¸æ“‡å¾Œç«‹å³è§¸ç™¼ `onRangeChange` callbackï¼ˆä¸éœ€ç¢ºèªæŒ‰éˆ•ï¼‰
  - [x] æ¨£å¼ï¼šä½¿ç”¨ Tailwind CSSï¼ŒéŸ¿æ‡‰å¼è¨­è¨ˆ

- [ ] Task 2.3: æ•´åˆè‡³çµ±è¨ˆé é¢
  - [x] åœ¨ `src/app/dashboard/viewer/[channelId]/page.tsx` å¼•å…¥ TimeRangeSelector
  - [x] ç®¡ç†æ™‚é–“ç¯„åœ stateï¼ˆä½¿ç”¨ useStateï¼‰
  - [x] ç•¶ç¯„åœæ”¹è®Šæ™‚ï¼Œå‘¼å« API æ›´æ–°è³‡æ–™

### Task 3ï¼ˆAC 1ï¼‰å‰ç«¯ï¼šçµ±è¨ˆå¡ç‰‡å…ƒä»¶

- [ ] Task 3.1: å»ºç«‹çµ±è¨ˆæ‘˜è¦å¡ç‰‡
  - [x] æ–°å¢ `src/features/viewer-dashboard/components/WatchStatsSummary.tsx`
  - [x] é¡¯ç¤º 4 å€‹ä¸»è¦æŒ‡æ¨™å¡ç‰‡ï¼š
    - ã€Œç´¯ç©è§€çœ‹æ™‚æ•¸ã€ï¼ˆæ ¼å¼åŒ–ç‚º HH:MMï¼‰
    - ã€Œå¹³å‡æ¯æ¬¡è§€çœ‹æ™‚é•·ã€ï¼ˆåˆ†é˜ï¼‰
    - ã€Œè§€çœ‹æ¬¡æ•¸ã€
    - ã€Œæœ€å¾Œè§€çœ‹æ—¥æœŸã€
  - [x] å¡ç‰‡é ‚éƒ¨é¡¯ç¤ºã€Œæ™‚é–“ç¯„åœã€æ¨™ç±¤
  - [x] Loading ç‹€æ…‹ï¼šé¡¯ç¤ºéª¨æ¶å±æˆ– Spinner
  - [x] Error ç‹€æ…‹ï¼šé¡¯ç¤ºé‡è©¦æŒ‰éˆ•

- [ ] Task 3.2: è³‡æ–™æ ¼å¼åŒ–å·¥å…·
  - [x] æ–°å¢ `src/lib/format.utils.ts`ï¼ˆè‹¥æœªå­˜åœ¨ï¼‰
  - [x] å¯¦ä½œå‡½æ•¸ï¼š
    - `formatWatchTime(minutes: number): string` â†’ "156:42"
    - `formatRelativeTime(date: Date): string` â†’ "2 å¤©å‰"
    - `formatDate(date: Date): string` â†’ "Nov 28"

### Task 4ï¼ˆAC 3ï¼‰å‰ç«¯ï¼šæ¯æ—¥è§€çœ‹è¶¨å‹¢åœ–è¡¨

- [ ] Task 4.1: å»ºç«‹æŠ˜ç·šåœ–å…ƒä»¶
  - [x] æ–°å¢ `src/features/viewer-dashboard/components/WatchTrendChart.tsx`
  - [x] ä½¿ç”¨ Recharts LineChartï¼š
    ```typescript
    <LineChart data={dailyBreakdown}>
      <CartesianGrid strokeDasharray="3 3" />
      <XAxis dataKey="date" tickFormatter={formatDate} />
      <YAxis label={{ value: 'æ™‚æ•¸ (åˆ†é˜)', angle: -90, position: 'insideLeft' }} />
      <Tooltip content={<CustomTooltip />} />
      <Line
        type="monotone"
        dataKey="watchTimeMinutes"
        stroke="#3b82f6"
        strokeWidth={2}
        dot={{ fill: '#3b82f6', r: 4 }}
        activeDot={{ r: 6 }}
      />
    </LineChart>
    ```
  - [x] éŸ¿æ‡‰å¼å¯¬åº¦ï¼ˆä½¿ç”¨ ResponsiveContainerï¼‰

- [ ] Task 4.2: è‡ªè¨‚ Tooltip æ¨£å¼
  - [x] å»ºç«‹ `CustomTooltip` å…ƒä»¶
  - [x] é¡¯ç¤ºï¼šæ—¥æœŸã€è§€çœ‹æ™‚æ•¸ã€è§€çœ‹æ¬¡æ•¸
  - [x] æ¨£å¼ç¬¦åˆè¨­è¨ˆç³»çµ±ï¼ˆTailwindï¼‰

- [ ] Task 4.3: æ•´åˆåœ–è¡¨è‡³çµ±è¨ˆé é¢
  - [x] å¼•å…¥ WatchTrendChart
  - [x] å‚³å…¥ `dailyBreakdown` è³‡æ–™
  - [x] åœ¨ Loading æœŸé–“é¡¯ç¤ºéª¨æ¶å±

### Task 5ï¼ˆAC 6ï¼‰å‰ç«¯ï¼šèª¤å·®è™•ç†èˆ‡é©—è­‰

- [ ] Task 5.1: å®¢ç«¯æ—¥æœŸé©—è­‰
  - [x] æª¢æŸ¥ startDate <= endDate
  - [x] æª¢æŸ¥æ—¥æœŸæ ¼å¼æœ‰æ•ˆæ€§
  - [x] è‹¥ç„¡æ•ˆï¼Œé¡¯ç¤ºè­¦å‘Š Toast è¨Šæ¯

- [ ] Task 5.2: API éŒ¯èª¤è™•ç†
  - [x] æ•æ‰ HTTP 400/403/500 éŒ¯èª¤
  - [x] é¡¯ç¤ºå‹å–„çš„ä½¿ç”¨è€…è¨Šæ¯
  - [x] æä¾›ã€Œé‡è©¦ã€æˆ–ã€Œè¿”å›ã€é¸é …

- [ ] Task 5.3: è³‡æ–™é©—è­‰
  - [x] æª¢æŸ¥ API éŸ¿æ‡‰çµæ§‹
  - [x] è‹¥è³‡æ–™ä¸å®Œæ•´ï¼Œé¡¯ç¤ºã€Œè³‡æ–™æš«ä¸å¯ç”¨ã€è¨Šæ¯

### Task 6ï¼ˆAC 4, 5ï¼‰å¾Œç«¯ï¼šè³‡æ–™æº–å‚™èˆ‡äº‹ä»¶ä¾†æº

- [ ] Task 6.1: ç¢ºèª EventSub è³‡æ–™æµ
  - [x] é©—è­‰ EventSub Webhook æ˜¯å¦æ­£ç¢ºå¯«å…¥ EventSub logsï¼ˆæˆ– ViewerChannelDailyStatï¼‰
  - [x] è‹¥ ViewerChannelDailyStat è¡¨å°šä¸å­˜åœ¨ï¼Œå»ºç«‹é·ç§»ï¼ˆStory 2.1 æ‡‰å·²æº–å‚™ï¼‰
  - [x] Mock æ¸¬è©¦è³‡æ–™ï¼ˆ100+ ç­†è·¨å¤šæ—¥æœŸï¼‰ä»¥ä¾›å¾ŒçºŒæ¸¬è©¦

- [ ] Task 6.2: å„ªåŒ–æŸ¥è©¢æ€§èƒ½
  - [x] åœ¨ (viewerId, channelId, date) ä¸Šå»ºç«‹è¤‡åˆç´¢å¼•
  - [x] é©—è­‰æŸ¥è©¢åŸ·è¡Œæ™‚é–“ < 100msï¼ˆä½¿ç”¨ EXPLAIN QUERY PLANï¼‰

### Task 7ï¼ˆAC 7ï¼‰å¾Œç«¯ï¼šå®‰å…¨æ—¥èªŒèˆ‡ç›£æ§

- [ ] Task 7.1: è¨˜éŒ„æœªæˆæ¬Šå­˜å–
  - [x] æ–°å¢æ—¥èªŒï¼šèª°åœ¨ä½•æ™‚å˜—è©¦å­˜å–ä»–äººçš„çµ±è¨ˆè³‡æ–™
  - [x] è¨˜éŒ„æ ¼å¼ï¼š`{ timestamp, userId, targetViewerId, endpoint, status }`

- [ ] Task 7.2: ç›£æ§ API æ•ˆèƒ½
  - [x] æ–°å¢æŒ‡æ¨™ï¼šèšåˆæŸ¥è©¢ response time
  - [x] è¨­ç½®å‘Šè­¦ï¼ˆè‹¥ p95 > 500msï¼Œé€šçŸ¥é–‹ç™¼åœ˜éšŠï¼‰

### Task 8: æ•´åˆèˆ‡å®Œæ•´æ€§æ¸¬è©¦

- [ ] Task 8.1: ç«¯åˆ°ç«¯æ¸¬è©¦ï¼ˆE2Eï¼‰
  - [x] å»ºç«‹ Playwright æ¸¬è©¦ `e2e/viewer-watch-stats.spec.ts`
  - [x] å ´æ™¯ï¼š
    1. ç™»å…¥ â†’ é€²å…¥é »é“çµ±è¨ˆé é¢
    2. é»æ“Šã€Œ7 å¤©ã€â†’ é©—è­‰åœ–è¡¨æ›´æ–°
    3. é¸æ“‡è‡ªè¨‚æ—¥æœŸ â†’ é©—è­‰åœ–è¡¨æ›´æ–°
    4. é©—è­‰å¡ç‰‡æ•¸å€¼æ­£ç¢ºæ€§

- [ ] Task 8.2: æ•ˆèƒ½æ¸¬è©¦
  - [x] æ¸¬è©¦ 100+ æ—¥æœŸç¯„åœçš„èšåˆæŸ¥è©¢ï¼ˆç›®æ¨™ < 100msï¼‰
  - [x] æ¸¬è©¦å‰ç«¯åœ–è¡¨æ¸²æŸ“æ•ˆèƒ½ï¼ˆ1000+ è³‡æ–™é»ï¼Œç›®æ¨™ < 1 ç§’ï¼‰

- [ ] Task 8.3: è·¨ç€è¦½å™¨æ¸¬è©¦
  - [x] Chromeã€Firefoxã€Safari ä¸Šé©—è­‰åœ–è¡¨é¡¯ç¤º

- [ ] Task 8.4: å¯è¨ªå•æ€§æª¢æŸ¥
  - [x] é©—è­‰åœ–è¡¨çš„ alt text
  - [x] é©—è­‰æ—¥æœŸé¸æ“‡å™¨çš„éµç›¤æ“ä½œ

### Task 9: æ–‡ä»¶èˆ‡äº¤ä»˜

- [ ] Task 9.1: æ›´æ–° API æ–‡ä»¶
  - [x] æ–°å¢ `GET /api/viewer/:viewerId/channels/:channelId/watch-stats` çš„ OpenAPI è¦ç¯„

- [ ] Task 9.2: å‰ç«¯çµ„ä»¶æ–‡ä»¶
  - [x] è¨˜éŒ„ `TimeRangeSelector`, `WatchStatsSummary`, `WatchTrendChart` çš„ä½¿ç”¨æ–¹å¼
  - [x] åŒ…å« Props å®šç¾©èˆ‡ç¯„ä¾‹ç”¨æ³•

---

## Dev Notes

### æŠ€è¡“æ±ºç­–è¨˜éŒ„

**æ±ºç­– 1ï¼šåœ–è¡¨åº«**
- âœ… é¸æ“‡ï¼š**Rechartsï¼ˆæ–¹æ¡ˆ Aï¼‰**
- ç†ç”±ï¼šèˆ‡ Epic 1 ä¸€è‡´ï¼Œåœ˜éšŠç†Ÿæ‚‰ï¼Œäº¤ä»˜å¿«é€Ÿ
- æª”æ¡ˆåƒè€ƒï¼šEpic 1 StreamSummaryCards å¯¦ä½œ

**æ±ºç­– 2ï¼šæ™‚é–“ç¯„åœé¸æ“‡**
- âœ… é¸æ“‡ï¼š**é è¨­ + è‡ªè¨‚æ··åˆï¼ˆæ–¹æ¡ˆ Cï¼‰**
- ç†ç”±ï¼šæä¾›éˆæ´»æ€§åŒæ™‚ä¿æŒç°¡æ½”é è¨­é¸é …
- å¯¦ä½œé›£åº¦ï¼šä¸­ç­‰ï¼ˆéœ€è¦ DatePicker åº« + ç‹€æ…‹ç®¡ç†ï¼‰

**æ±ºç­– 3ï¼šè³‡æ–™èšåˆ**
- âœ… é¸æ“‡ï¼š**è³‡æ–™åº«è¦–åœ–ï¼ˆç‰©åŒ–è¦–åœ–ï¼Œæ–¹æ¡ˆ Cï¼‰**
- ç†ç”±ï¼šå¤§å¹…æå‡æŸ¥è©¢æ€§èƒ½ï¼Œå°¤å…¶ç•¶ 90 å¤©è³‡æ–™å¢é•·æ™‚
- å¯¦ä½œï¼šæ¯å°æ™‚ Cron Job åˆ·æ–°è¦–åœ–
- æ¬Šè¡¡ï¼šå¤šäº†ä¸€å¼µè¡¨å’Œå®šæ™‚ä»»å‹™ç¶­è­·æˆæœ¬ï¼Œä½†æŸ¥è©¢é€Ÿåº¦ < 100ms

**æ±ºç­– 4ï¼šåœ–è¡¨ç²’åº¦**
- âœ… é¸æ“‡ï¼š**æ¯æ—¥æŠ˜ç·šåœ–ï¼ˆæ–¹æ¡ˆ Aï¼‰**
- ç†ç”±ï¼šå……åˆ†å±•ç¾è§€çœ‹è¶¨å‹¢ï¼Œè³‡æ–™é»ä¸æœƒéå¤šï¼ˆæœ€å¤š 90 å€‹ï¼‰
- å¾ŒçºŒå¯å‡ç´šç‚ºæ›´è¤‡é›œèšåˆï¼ˆå¦‚æŒ‰å°æ™‚ã€æŒ‰é¡å‹ï¼‰

**æ±ºç­– 5ï¼šMock è³‡æ–™**
- âœ… é¸æ“‡ï¼š**å¯¦æ™‚ APIï¼ˆæ–¹æ¡ˆ Cï¼‰**
- ç†ç”±ï¼šStory 2.1 çš„ Mock å·²æä¾›è§€çœ¾æ¸…å–®ï¼Œæœ¬ Story æ‡‰æ”¶é›†å¯¦éš›è§€çœ‹äº‹ä»¶
- å¯¦ä½œï¼šEventSub Webhook æŒçºŒå¯«å…¥ `ViewerChannelDailyStat` æˆ– Event logs
- æ¸¬è©¦æ™‚ï¼šä½¿ç”¨ Mock Event Payload é€²è¡Œé›†æˆæ¸¬è©¦

### èˆ‡ Epic 1 çš„ä»£ç¢¼è¤‡ç”¨é»

1. **API æ¶æ§‹**
   - è¤‡ç”¨ Controller â†’ Service â†’ Repository æ¨¡å¼
   - è¤‡ç”¨ JWT èªè­‰ä¸­ä»‹è»Ÿé«”
   - è¤‡ç”¨ API éŒ¯èª¤è™•ç†èˆ‡æ—¥èªŒ

2. **å‰ç«¯**
   - è¤‡ç”¨ useAuthSession Hook
   - è¤‡ç”¨ API clientï¼ˆhttpClientï¼‰
   - è¤‡ç”¨ Tailwind CSS å…ƒä»¶ï¼ˆCard, Button, etc.ï¼‰
   - è¤‡ç”¨ Recharts LineChart çš„åŸºç¤æ¨£å¼

3. **æ¸¬è©¦**
   - è¤‡ç”¨ Jest å–®å…ƒæ¸¬è©¦æ¶æ§‹
   - è¤‡ç”¨ Playwright E2E æ¸¬è©¦æ¡†æ¶

### æ–°å¼•å…¥çš„æŠ€è¡“/åº«

| åº« | ç”¨é€” | ç‰ˆæœ¬ | å‚™è¨» |
|----|------|------|------|
| `react-day-picker` | æ—¥æœŸé¸æ“‡å™¨ UI | ^8.x | è¼•é‡ã€Headless |
| `date-fns` | æ—¥æœŸæ ¼å¼åŒ– | ^2.30 | å·²åœ¨ Recharts ä¸­ä½¿ç”¨ |
| `node-cron` æˆ– `bull` | å®šæ™‚ä»»å‹™ | Latest | ç”¨æ–¼ç‰©åŒ–è¦–åœ–åˆ·æ–° |

### è³‡æ–™æµåœ–

```
EventSub Webhook
    â†“
ViewerChannelDailyStat (å¯¦æ™‚å¯«å…¥)
    â†“
Cron Job (æ¯å°æ™‚)
    â†“
Materialized View: ViewerChannelDailyAgg (èšåˆè¡¨)
    â†“
API: GET /api/viewer/:viewerId/channels/:channelId/watch-stats
    â†“
Frontend: TimeRangeSelector è§¸ç™¼æŸ¥è©¢
    â†“
WatchStatsSummary (å¡ç‰‡) + WatchTrendChart (åœ–è¡¨)
```

### å¾Œç«¯æª”æ¡ˆæ¸…å–®ï¼ˆé è¨ˆä¿®æ”¹/æ–°å¢ï¼‰

#### æ–°å¢ï¼š
- `src/modules/viewer/viewer-stats.controller.ts` â€“ çµ±è¨ˆæŸ¥è©¢ç«¯é»
- `src/modules/viewer/viewer-stats.service.ts` â€“ çµ±è¨ˆæ¥­å‹™é‚è¼¯
- `src/modules/viewer/viewer-stats.repository.ts` â€“ èšåˆè¦–åœ–æŸ¥è©¢
- `src/services/aggregation.service.ts` â€“ ç‰©åŒ–è¦–åœ–åˆ·æ–°
- `src/jobs/refresh-viewer-daily-agg.job.ts` â€“ Cron Job å®šç¾©
- `prisma/migrations/{timestamp}_add_viewer_daily_agg.sql` â€“ é·ç§»æª”

#### ä¿®æ”¹ï¼š
- `prisma/schema.prisma` â€“ æ–°å¢ ViewerChannelDailyAgg è³‡æ–™æ¨¡å‹
- `src/app.ts` æˆ– `main.ts` â€“ è¨»å†Š Cron Job
- `src/modules/viewer/viewer.routes.ts` â€“ æ–°å¢çµ±è¨ˆè·¯ç”±

### å‰ç«¯æª”æ¡ˆæ¸…å–®ï¼ˆé è¨ˆä¿®æ”¹/æ–°å¢ï¼‰

#### æ–°å¢ï¼š
- `src/features/viewer-dashboard/components/TimeRangeSelector.tsx` â€“ æ™‚é–“ç¯„åœé¸æ“‡å™¨
- `src/features/viewer-dashboard/components/WatchStatsSummary.tsx` â€“ çµ±è¨ˆå¡ç‰‡
- `src/features/viewer-dashboard/components/WatchTrendChart.tsx` â€“ æŠ˜ç·šåœ–
- `src/features/viewer-dashboard/components/CustomTooltip.tsx` â€“ åœ–è¡¨ Tooltip
- `src/lib/format.utils.ts` â€“ æ ¼å¼åŒ–å·¥å…·å‡½æ•¸
- `src/lib/api/viewer-stats.ts` â€“ çµ±è¨ˆ API client

#### ä¿®æ”¹ï¼š
- `src/app/dashboard/viewer/[channelId]/page.tsx` â€“ æ•´åˆé¸æ“‡å™¨ã€å¡ç‰‡ã€åœ–è¡¨
- `frontend/package.json` â€“ æ–°å¢ react-day-picker, date-fns

### ç’°å¢ƒè®Šæ•¸

#### å¾Œç«¯æ–°å¢ï¼ˆå¯é¸ï¼‰ï¼š
```bash
AGGREGATION_CRON_EXPRESSION=0 * * * *  # æ¯å°æ™‚çš„ç¬¬ 0 åˆ†
AGGREGATION_BATCH_SIZE=1000             # æ¯æ¬¡åˆ·æ–°çš„æœ€å¤§ç­†æ•¸
```

### ç›¸ä¾æ€§èˆ‡å…ˆæ±ºæ¢ä»¶

- âœ… Story 2.1 å®Œæˆï¼ˆè§€çœ¾ç™»å…¥èˆ‡æˆæ¬Šã€Mock è§€çœ¾è³‡æ–™ï¼‰
- âœ… EventSub Webhook åŸºç¤ï¼ˆæ¥æ”¶ Twitch äº‹ä»¶ï¼‰
- â³ ViewerChannelDailyStat è¡¨çµæ§‹å·²å®šç¾©ï¼ˆStory 2.1 æ‡‰æ¶µè“‹æˆ–æœ¬ Story è£œå……ï¼‰
- â³ Mock EventSub äº‹ä»¶è³‡æ–™é›†ï¼ˆç”¨æ–¼æ¸¬è©¦ï¼‰

---

## Project Structure Notes

```
backend/
  src/
    modules/
      viewer/
        viewer-stats.controller.ts    â† æ–°å¢
        viewer-stats.service.ts       â† æ–°å¢
        viewer-stats.repository.ts    â† æ–°å¢
    
    services/
      aggregation.service.ts          â† æ–°å¢
    
    jobs/
      refresh-viewer-daily-agg.job.ts â† æ–°å¢
    
    utils/
      (æ—¢æœ‰å·¥å…·å¦‚ format, crypto ç­‰)

  prisma/
    schema.prisma                     â† ä¿®æ”¹ï¼šæ–°å¢ ViewerChannelDailyAgg è³‡æ–™æ¨¡å‹
    migrations/
      {timestamp}_add_viewer_daily_agg â† æ–°å¢

frontend/
  src/
    features/
      viewer-dashboard/
        components/
          TimeRangeSelector.tsx       â† æ–°å¢
          WatchStatsSummary.tsx       â† æ–°å¢
          WatchTrendChart.tsx         â† æ–°å¢
          CustomTooltip.tsx           â† æ–°å¢
    
    lib/
      format.utils.ts                â† æ–°å¢æˆ–æ“´å±•
      api/
        viewer-stats.ts              â† æ–°å¢
    
    app/
      dashboard/
        viewer/
          [channelId]/
            page.tsx                 â† ä¿®æ”¹ï¼šæ•´åˆé¸æ“‡å™¨ã€å¡ç‰‡ã€åœ–è¡¨
```

---

## Definition of Done

- [ ] æ‰€æœ‰ AC éƒ½å·²å¯¦ä½œ
- [ ] æ‰€æœ‰ Tasks éƒ½å·²å®Œæˆï¼ˆcheckbox æ¨™è¨˜ [x]ï¼‰
- [ ] ç‰©åŒ–è¦–åœ–æ¯å°æ™‚æ­£ç¢ºåˆ·æ–°ï¼ˆé©—è­‰æ–¼è³‡æ–™åº«ï¼‰
- [ ] API èšåˆæŸ¥è©¢æ€§èƒ½ < 100msï¼ˆp95ï¼‰
- [ ] å‰ç«¯æ™‚é–“ç¯„åœé¸æ“‡å™¨èƒ½æ­£ç¢ºè§¸ç™¼æŸ¥è©¢
- [ ] åœ–è¡¨åœ¨ Chrome/Firefox/Safari ä¸Šæ¸²æŸ“æ­£ç¢º
- [ ] å¾Œç«¯å–®å…ƒæ¸¬è©¦é€šéç‡ 100%
- [ ] å‰ç«¯çµ„ä»¶æ¸¬è©¦é€šéç‡ 100%
- [ ] E2E æ¸¬è©¦æ¶µè“‹å®Œæ•´ 7/30/90 å¤©èˆ‡è‡ªè¨‚æ—¥æœŸå ´æ™¯
- [ ] ç„¡ ESLint éŒ¯èª¤
- [ ] ç„¡ TypeScript é¡å‹éŒ¯èª¤
- [ ] API æ–‡ä»¶å·²æ›´æ–°ï¼ˆOpenAPI/Swaggerï¼‰
- [ ] ç¨‹å¼ç¢¼å·²æäº¤è‡³ gitï¼ŒPR å·²é€šéå¯©æŸ¥
- [ ] æ•ˆèƒ½æ¸¬è©¦é€šéï¼ˆ100+ å¤©è³‡æ–™æŸ¥è©¢ < 100msï¼‰

