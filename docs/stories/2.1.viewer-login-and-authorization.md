# Story 2.1: è§€çœ¾ç™»å…¥èˆ‡æˆæ¬Š

## Status

- ğŸ“‹ Draft
- å»ºç«‹æ—¥æœŸï¼š2025-12-11

## Related Documents

- `docs/epic-2-viewer-engagement-analytics.md#4-user-stories` â€“ Story 2.1 åŸå§‹éœ€æ±‚èƒŒæ™¯
- `docs/prd.md#3-ç›®æ¨™ç”¨æˆ¶èˆ‡ä½¿ç”¨æƒ…å¢ƒ` â€“ è§€çœ¾ç”¨æˆ¶è§’è‰²å®šç¾©
- `docs/architecture/fullstack-architecture.md` â€“ æŠ€è¡“æ¶æ§‹åƒè€ƒ
- `docs/architecture/coding-standards.md` â€“ ç¨‹å¼ç¢¼æ¨™æº–
- `docs/architecture/tech-stack.md` â€“ æŠ€è¡“æ£§ç¢ºèª

## Story

**As a** é‡åº¦è§€çœ¾æˆ–é »é“ç®¡ç†å“¡ï¼ˆViewer/Community Managerï¼‰  
**I want** ä½¿ç”¨ Twitch å¸³è™Ÿç™»å…¥å¹³å°  
**so that** æˆ‘èƒ½æŸ¥çœ‹è‡ªå·±åœ¨ç‰¹å®šå¯¦æ³ä¸»é »é“çš„è§€çœ‹èˆ‡äº’å‹•çµ±è¨ˆæ•¸æ“šï¼Œä»¥é‡åŒ–è‡ªå·±çš„æ”¯æŒç¨‹åº¦ã€‚

## Acceptance Criteria

### AC 1: è§€çœ¾ Twitch OAuth ç™»å…¥æµç¨‹
- Given è§€çœ¾é€ è¨ªå¹³å°é¦–é 
- When è§€çœ¾é»æ“Šã€Œä»¥ Twitch å¸³è™Ÿç™»å…¥ï¼ˆè§€çœ¾ï¼‰ã€æŒ‰éˆ•
- Then ç³»çµ±å°‡è§€çœ¾é‡å°å‘ Twitch OAuth æˆæ¬Šé é¢ï¼Œè¦æ±‚ä»¥ä¸‹æ¬Šé™ï¼š
  - `user:read:email` â€“ è®€å–å¸³è™Ÿéƒµç®±
  - `chat:read` â€“ è®€å–èŠå¤©è¨Šæ¯ï¼ˆç”¨æ–¼çµ±è¨ˆç•™è¨€ï¼‰
- And ç³»çµ±ç”Ÿæˆä¸¦å„²å­˜ State åƒæ•¸æ–¼ HTTP-only Cookieï¼ˆé˜² CSRFï¼‰
- And ç”¨æˆ¶åŒæ„æˆæ¬Šå¾Œï¼ŒTwitch å›å°è‡³ `/auth/viewer/callback`

### AC 2: è§€çœ¾è³‡æ–™é¦–æ¬¡å»ºç«‹èˆ‡åŒæ„
- Given è§€çœ¾é¦–æ¬¡æˆåŠŸæˆæ¬Šä¸¦å›å°åˆ° `/auth/viewer/callback`
- When ç³»çµ±é©—è­‰ Twitch OAuth Code ä¸¦äº¤æ› Access Token
- Then ç³»çµ±æ‡‰ï¼š
  - å‰µå»ºæ–° Viewer è¨˜éŒ„ï¼ˆè‹¥ä¸å­˜åœ¨ï¼‰æ–¼è³‡æ–™åº«
  - å„²å­˜ Twitch User IDã€Display Nameã€Avatar URL
  - é¡¯ç¤ºã€Œè³‡æ–™ä½¿ç”¨èªªæ˜èˆ‡éš±ç§åŒæ„ã€é é¢ï¼ˆä¸€æ¬¡æ€§ï¼‰
  - å¾…ç”¨æˆ¶ç¢ºèªåŒæ„å¾Œï¼Œæ–¹å¯é€²å…¥å„€è¡¨æ¿
- And ç³»çµ±è¨˜éŒ„ç”¨æˆ¶çš„åŒæ„æ™‚é–“æˆ³è¨˜ï¼ˆç”¨æ–¼éš±ç§å¯©è¨ˆï¼‰

### AC 3: JWT èªè­‰èˆ‡ Role å€åˆ†
- Given è§€çœ¾æˆåŠŸæˆæ¬Šä¸¦åŒæ„éš±ç§æ¢æ¬¾
- When ç³»çµ±ç°½ç™¼ JWT Token
- Then Token Payload æ‡‰åŒ…å«ï¼š
  ```typescript
  {
    twitchUserId: string;
    displayName: string;
    role: 'viewer';  // å€åˆ†å¯¦æ³ä¸»
    iat: number;
    exp: number;
  }
  ```
- And Token å„²å­˜æ–¼ HTTP-only Cookieï¼ˆ`access_token`ï¼‰
- And Token æœ‰æ•ˆæœŸç‚º 1 å°æ™‚ï¼Œä¸¦æ”¯æ´ Refresh Token æ›æ–°

### AC 4: è§€çœ¾å„€è¡¨æ¿é¦–é èˆ‡å°è¦½
- Given è§€çœ¾å·²æˆåŠŸç™»å…¥
- When è§€çœ¾é€²å…¥ `/dashboard/viewer`
- Then ç³»çµ±æ‡‰é¡¯ç¤ºï¼š
  - æ­¡è¿è¨Šæ¯ï¼ˆå«è§€çœ¾ Display Nameï¼‰
  - å·²è¿½è¹¤çš„å¯¦æ³ä¸»æ¸…å–®ï¼ˆæœå°‹/ç¯©é¸åŠŸèƒ½ï¼‰
  - ã€Œé¸æ“‡é »é“æŸ¥çœ‹çµ±è¨ˆã€çš„ä¸»è¦å…¥å£
  - ã€Œå¸³è™Ÿè¨­å®š / éš±ç§æ§åˆ¶ã€é€£çµ
- And è‹¥è§€çœ¾å°šæœªè¿½è¹¤ä»»ä½•å¯¦æ³ä¸»ï¼Œé¡¯ç¤ºã€Œé–‹å§‹æ¢ç´¢ã€CTA

### AC 5: Twitch Token å®‰å…¨ç®¡ç†
- Given ç³»çµ±å·²å–å¾— Viewer çš„ Twitch Access Token
- When Token éœ€è¢«å„²å­˜æˆ–ä½¿ç”¨
- Then ç³»çµ±æ‡‰ï¼š
  - åŠ å¯†å„²å­˜æ–¼è³‡æ–™åº« `TwitchToken` è¡¨
  - ä¸åœ¨å‰ç«¯æš´éœ²åŸå§‹ Tokenï¼ˆæ‰€æœ‰ Twitch API å‘¼å«æ‡‰ç”±å¾Œç«¯ä»£ç†ï¼‰
  - å®šæœŸæª¢æŸ¥ Token æœ‰æ•ˆæœŸï¼Œè‡ªå‹•åˆ·æ–°ï¼ˆè‹¥ Refresh Token ä»æœ‰æ•ˆï¼‰
  - æä¾›å®‰å…¨çš„æ’¤éŠ·æ©Ÿåˆ¶ï¼ˆç”¨æˆ¶å¯æ‰‹å‹•ç™»å‡ºï¼‰

### AC 6: ç™»å‡ºèˆ‡ Token æ’¤éŠ·
- Given è§€çœ¾å·²ç™»å…¥
- When è§€çœ¾é»æ“Šã€Œç™»å‡ºã€æˆ–ã€Œæ’¤éŠ·æˆæ¬Šã€
- Then ç³»çµ±æ‡‰ï¼š
  - æ¸…é™¤å‰ç«¯ Cookieï¼ˆ`access_token`ï¼‰
  - å°‡å¾Œç«¯çš„ Twitch Refresh Token è¨­ç‚ºç„¡æ•ˆ
  - é‡å°è‡³ç™»å‡ºç¢ºèªé é¢ï¼ˆé¡¯ç¤ºã€Œå·²æˆåŠŸç™»å‡ºã€è¨Šæ¯ï¼‰
  - ç”¨æˆ¶ä¸‹æ¬¡é€ è¨ªé ˆé‡æ–°æˆæ¬Š

## Tasks / Subtasks

### Task 1ï¼ˆAC 1, 3ï¼‰å¾Œç«¯ï¼šViewer Auth æ¨¡çµ„å¯¦ä½œ
- [ ] Task 1.1: æ“´å±• Auth Controllerï¼Œæ–°å¢ Viewer OAuth ç«¯é»
  - [x] `POST /auth/viewer/login` â€“ ç”¢ç”Ÿ Stateã€é‡å°è‡³ Twitch
  - [x] `GET /auth/viewer/callback?code=XXX&state=XXX` â€“ é©—è­‰ Codeã€äº¤æ› Token
  - å‚™è¨»ï¼šå¯è¤‡ç”¨ Epic 1 çš„ OAuth é‚è¼¯ï¼Œæ–¼æ§åˆ¶å™¨å±¤å€åˆ† role

- [ ] Task 1.2: ä¿®æ”¹ Auth Serviceï¼Œæ”¯æ´ Viewer Role
  - [x] æ–°å¢ `handleViewerTwitchCallback()` æ–¹æ³•ï¼ˆé¡ä¼¼ handleStreamerTwitchCallbackï¼‰
  - [x] é‚è¼¯ï¼šé©—è­‰ State â†’ äº¤æ› Token â†’ æŸ¥è©¢æˆ–å»ºç«‹ Viewer è¨˜éŒ„ â†’ ç°½ç™¼ JWTï¼ˆrole: 'viewer'ï¼‰
  - [x] è¿”å› JWT èˆ‡ Refresh Token

- [ ] Task 1.3: ä¿®æ”¹ JWT ç°½ç™¼é‚è¼¯ï¼ŒåŠ å…¥ role æ¬„ä½
  - [x] æ“´å±• `JWTPayload` interfaceï¼Œæ–°å¢ `role: 'streamer' | 'viewer'`
  - [x] `signToken()` æ™‚å‚³å…¥ role åƒæ•¸

### Task 2ï¼ˆAC 2ï¼‰å¾Œç«¯ï¼šViewer éš±ç§åŒæ„æµç¨‹
- [ ] Task 2.1: æ–°å¢ã€ŒåŒæ„è¿½è¹¤ã€API ç«¯é»
  - [x] `POST /api/viewer/consent` â€“ è¨˜éŒ„ç”¨æˆ¶åŒæ„æ™‚é–“æˆ³è¨˜
  - [x] Request Body: `{ consented: boolean }`
  - [x] Response: `{ viewerId: string, consentedAt: datetime }`
  - [x] éœ€èªè­‰ï¼ˆéœ€æœ‰æ•ˆ JWTï¼‰

- [ ] Task 2.2: ä¿®æ”¹ Viewer è³‡æ–™æ¨¡å‹
  - [x] æ–°å¢æ¬„ä½ï¼š`consentedAt?: DateTime` â€“ è¨˜éŒ„éš±ç§åŒæ„æ™‚é–“
  - [x] æ–°å¢æ¬„ä½ï¼š`consentVersion?: Int` â€“ ç‰ˆæœ¬è¿½è¹¤ï¼ˆç”¨æ–¼éš±ç§æ”¿ç­–æ›´æ–°ï¼‰
  - [x] ç„¡é ˆ migrateï¼Œå¯æ–¼æœ¬ Story å®Œæˆå‰é€²è¡Œ

### Task 3ï¼ˆAC 5ï¼‰å¾Œç«¯ï¼šTwitch Token åŠ å¯†å„²å­˜
- [ ] Task 3.1: å»ºç«‹ Token åŠ å¯†/è§£å¯†å·¥å…·
  - [x] æ–°å¢ `utils/crypto.utils.ts`
  - [x] å¯¦ä½œ `encryptToken(token: string): string`
  - [x] å¯¦ä½œ `decryptToken(encrypted: string): string`
  - [x] ä½¿ç”¨å°ç¨±åŠ å¯†ï¼ˆå¦‚ AES-256-GCMï¼‰ï¼Œé‡‘é‘°å¾ç’°å¢ƒè®Šæ•¸è®€å–

- [ ] Task 3.2: ä¿®æ”¹ Auth Serviceï¼Œè‡ªå‹•åŠ å¯† Token
  - [x] å„²å­˜ Token å‰åŸ·è¡Œ encryptToken()
  - [x] ä½¿ç”¨ Token å‰åŸ·è¡Œ decryptToken()

### Task 4ï¼ˆAC 4ï¼‰å‰ç«¯ï¼šè§€çœ¾å„€è¡¨æ¿æ¡†æ¶
- [ ] Task 4.1: æ–°å¢è§€çœ¾é¦–é è·¯ç”±èˆ‡é é¢
  - [x] å»ºç«‹ `src/app/dashboard/viewer/page.tsx`
  - [x] é¡¯ç¤ºæ­¡è¿è¨Šæ¯èˆ‡è¿½è¹¤é »é“æ¸…å–®
  - [x] å¯¦ä½œé »é“æœå°‹ / ç¯©é¸ UI

- [ ] Task 4.2: å¯¦ä½œé »é“é¸æ“‡å™¨èˆ‡çµ±è¨ˆé é¢æ¡†æ¶
  - [x] å»ºç«‹ `src/app/dashboard/viewer/[channelId]/page.tsx`ï¼ˆå‹•æ…‹è·¯ç”±ï¼‰
  - [x] é¡¯ç¤ºé »é“åç¨±ã€é »é“åœ–ç‰‡
  - [x] é ç•™å€åŸŸç”¨æ–¼å¾ŒçºŒ Story 2.2/2.3 çµ±è¨ˆåœ–è¡¨

- [ ] Task 4.3: æ–°å¢è§€çœ¾å°è¦½é¸é …ï¼ˆHeader æˆ– Sidebarï¼‰
  - [x] å€åˆ†ã€Œå¯¦æ³ä¸»æ¨¡å¼ã€èˆ‡ã€Œè§€çœ¾æ¨¡å¼ã€
  - [x] æä¾›åˆ‡æ›æŒ‰éˆ•æˆ–è·¯ç”±é€£çµ

### Task 5ï¼ˆAC 4ï¼‰å‰ç«¯ï¼šè§€çœ¾ç™»å…¥æŒ‰éˆ•èˆ‡æˆæ¬Šæµç¨‹
- [ ] Task 5.1: ä¿®æ”¹ Landing Pageï¼Œæ–°å¢ã€Œè§€çœ¾ç™»å…¥ã€é¸é …
  - [x] æ–¼é¦–é æˆ–å°è¦½åˆ—æ–°å¢ã€Œä»¥ Twitch å¸³è™Ÿç™»å…¥ï¼ˆè§€çœ¾ï¼‰ã€æŒ‰éˆ•
  - [x] é»æ“Šæ™‚å°å‘ `/auth/viewer/login`

- [ ] Task 5.2: å»ºç«‹ç™»å‡ºé é¢
  - [x] `src/app/auth/viewer/logout.tsx`
  - [x] é¡¯ç¤ºç™»å‡ºç¢ºèªè¨Šæ¯èˆ‡è¿”å›é¦–é é€£çµ

### Task 6ï¼ˆAC 2ï¼‰å‰ç«¯ï¼šéš±ç§åŒæ„é é¢
- [ ] Task 6.1: å»ºç«‹éš±ç§åŒæ„é é¢
  - [x] `src/app/auth/viewer/consent.tsx`
  - [x] é¡¯ç¤ºã€Œè³‡æ–™ä½¿ç”¨èªªæ˜ã€
  - [x] æä¾›ã€ŒåŒæ„ã€èˆ‡ã€Œæ‹’çµ•ã€æŒ‰éˆ•
  - [x] åŒæ„æ™‚å‘¼å« `POST /api/viewer/consent` ä¸¦å°å‘å„€è¡¨æ¿
  - [x] æ‹’çµ•æ™‚å°å‘ç™»å‡ºæµç¨‹

### Task 7ï¼ˆAC 4ï¼‰å‰ç«¯ï¼šMock è³‡æ–™å±•ç¤ºï¼ˆç”¨æ–¼ UX é©—è­‰ï¼‰
- [ ] Task 7.1: å»ºç«‹ Mock API ç«¯é»æˆ– Mock è³‡æ–™
  - [x] æ–°å¢ `src/lib/api/__mocks__/viewer.ts` Mock è³‡æ–™
  - [x] åŒ…å« Mock é »é“æ¸…å–®ï¼ˆ5-10 å€‹ Twitch å¯¦æ³ä¸»ï¼‰
  - [x] åŒ…å« Mock æ¯æ—¥çµ±è¨ˆï¼ˆè§€çœ‹æ™‚æ•¸ã€ç•™è¨€æ•¸ï¼‰

- [ ] Task 7.2: è§€çœ¾å„€è¡¨æ¿é¦–é é¡¯ç¤º Mock é »é“æ¸…å–®
  - [x] ä½¿ç”¨ Mock è³‡æ–™æˆ–æ¢ä»¶å¼æ¸²æŸ“
  - [x] ä¸å½±éŸ¿å¯¦éš› API å‘¼å«ï¼ˆæ¸¬è©¦ç’°å¢ƒæ™‚å¯åˆ‡æ›ï¼‰

- [ ] Task 7.3: é »é“çµ±è¨ˆé é¢é¡¯ç¤º Mock è³‡æ–™
  - [x] é¡¯ç¤º Mock çš„æ—¥æœŸã€è§€çœ‹æ™‚æ•¸ã€ç•™è¨€æ•¸
  - [x] ç‚ºå¾ŒçºŒåœ–è¡¨åŠŸèƒ½é ç•™ç©ºé–“

### Task 8: æ¸¬è©¦èˆ‡ QA
- [ ] Task 8.1: å–®å…ƒæ¸¬è©¦ â€“ Auth Service (Viewer)
  - [x] æ¸¬è©¦ `handleViewerTwitchCallback()` é‚è¼¯
  - [x] æ¸¬è©¦ Token ç°½ç™¼ (role: 'viewer')
  - [x] æ¸¬è©¦æ–° Viewer å»ºç«‹ vs æ—¢æœ‰ Viewer ç™»å…¥

- [ ] Task 8.2: æ•´åˆæ¸¬è©¦ â€“ Viewer Auth API
  - [x] æ¸¬è©¦ OAuth æµç¨‹ç«¯åˆ°ç«¯ï¼ˆæ¨¡æ“¬ Twitch å›èª¿ï¼‰
  - [x] æ¸¬è©¦ Consent API

- [ ] Task 8.3: å‰ç«¯æ¸¬è©¦ â€“ ç™»å…¥ & å°è¦½æµç¨‹
  - [x] æ¸¬è©¦ç™»å…¥æŒ‰éˆ•ã€é‡å°
  - [x] æ¸¬è©¦éš±ç§åŒæ„é é¢
  - [x] æ¸¬è©¦ç™»å‡ºåŠŸèƒ½

- [ ] Task 8.4: E2E æ¸¬è©¦ â€“ Playwright
  - [x] å®Œæ•´ Viewer ç™»å…¥ â†’ åŒæ„ â†’ å„€è¡¨æ¿æµç¨‹

## Dev Notes

### æŠ€è¡“æ±ºç­–è¨˜éŒ„

**æ±ºç­– 1ï¼šAuth æ¶æ§‹**
- âœ… é¸æ“‡ï¼š**å…±ç”¨ Auth æµç¨‹ + Role å€åˆ†ï¼ˆæ–¹æ¡ˆ Aï¼‰**
- ç†ç”±ï¼šæœ€å¤§åŒ–ç¨‹å¼ç¢¼é‡ç”¨ï¼Œæ¸›å°‘ç¶­è­·æˆæœ¬
- å¯¦ä½œï¼šOAuth é‚è¼¯è¤‡ç”¨ï¼ŒController å±¤æ ¹æ“š `/auth/viewer/login` vs `/auth/streamer/login` è¨­ç½® role
- ä¾†æºï¼š[Epic 2 æŠ€è¡“æ–¹æ¡ˆè¨è«–](../PROJECT-STATUS.md)

**æ±ºç­– 2ï¼šè³‡æ–™ç²’åº¦**
- âœ… é¸æ“‡ï¼š**Daily Statsï¼ˆæ–¹æ¡ˆ Aï¼‰**
- ç†ç”±ï¼šè³‡æ–™é‡å°ã€æŸ¥è©¢æ•ˆèƒ½å¥½ï¼Œå¯ç”¨æ–¼é•·æœŸè§€çœ‹è¶¨å‹¢
- Hourly/Event-based ä¿ç•™ç‚ºæœªä¾†å„ªåŒ–é¸é …
- ä¾†æºï¼š[Epic 2 æŠ€è¡“æ–¹æ¡ˆè¨è«–](../PROJECT-STATUS.md)

**æ±ºç­– 3ï¼šè³‡æ–™æ”¶é›†æ–¹å¼**
- âœ… é¸æ“‡ï¼š**EventSub Webhooksï¼ˆæ–¹æ¡ˆ Aï¼‰**
- ç†ç”±ï¼šå®˜æ–¹ APIã€å³æ™‚æ€§å¥½ã€æ”¯æ´äº‹ä»¶è¨‚é–±
- å¯¦ä½œè¨ˆåŠƒï¼šStory 2.1 å»ºç«‹åŸºç¤ï¼ŒStory 2.2+ å¯¦è£ EventSub ç›£è½
- ä¾†æºï¼š[Epic 2 æŠ€è¡“æ–¹æ¡ˆè¨è«–](../PROJECT-STATUS.md)

**æ±ºç­– 4ï¼šStory 2.1 ç¯„åœ**
- âœ… é¸æ“‡ï¼š**Auth + Mock è³‡æ–™å±•ç¤ºï¼ˆOption 3ï¼‰**
- ç†ç”±ï¼šå®Œæ•´ UX é©—è­‰ï¼Œç‚ºå¾ŒçºŒ Stories å¥ å®šåŸºç¤
- Mock è³‡æ–™ï¼šåŒ…å«é »é“æ¸…å–®ã€æ¯æ—¥çµ±è¨ˆï¼ˆè§€çœ‹æ™‚æ•¸ã€ç•™è¨€æ•¸ï¼‰
- ä¾†æºï¼š[Epic 2 æŠ€è¡“æ–¹æ¡ˆè¨è«–](../PROJECT-STATUS.md)

### èˆ‡ Epic 1 çš„ä»£ç¢¼è¤‡ç”¨é»

1. **OAuth æ¡†æ¶**
   - è¤‡ç”¨ `TwitchOAuthClient`
   - è¤‡ç”¨ `signToken()` / `JWTPayload` çµæ§‹ï¼ˆåƒ…åŠ  role æ¬„ä½ï¼‰
   - è¤‡ç”¨ State ç”Ÿæˆèˆ‡é©—è­‰é‚è¼¯

2. **API éŒ¯èª¤è™•ç†**
   - è¤‡ç”¨ `handleTwitchCallback()` çš„éŒ¯èª¤æ¨¡å¼
   - è¤‡ç”¨ Logger å·¥å…·

3. **å‰ç«¯**
   - è¤‡ç”¨ `useAuthSession` Hookï¼ˆéœ€æ“´å±•æ”¯æ´ roleï¼‰
   - è¤‡ç”¨ API å‘¼å« clientï¼ˆhttpClientï¼‰
   - è¤‡ç”¨ Tailwind CSS è¨­è¨ˆç³»çµ±

### å¾Œç«¯æª”æ¡ˆæ¸…å–®ï¼ˆé è¨ˆä¿®æ”¹/æ–°å¢ï¼‰

#### ä¿®æ”¹ï¼š
- `src/modules/auth/auth.controller.ts` â€“ æ–°å¢ `/auth/viewer/*` ç«¯é»
- `src/modules/auth/auth.service.ts` â€“ æ–°å¢ `handleViewerTwitchCallback()` æ–¹æ³•
- `src/modules/auth/jwt.utils.ts` â€“ æ“´å±• `JWTPayload` interfaceï¼Œæ–°å¢ role
- `prisma/schema.prisma` â€“ æ–°å¢ Viewer æ¬„ä½ï¼ˆconsentedAt, consentVersionï¼‰

#### æ–°å¢ï¼š
- `src/modules/viewer/viewer.controller.ts` â€“ Viewer API æ§åˆ¶å™¨
- `src/modules/viewer/viewer.service.ts` â€“ Viewer æ¥­å‹™é‚è¼¯
- `src/modules/viewer/viewer.repository.ts` â€“ è³‡æ–™åº«æŸ¥è©¢
- `src/utils/crypto.utils.ts` â€“ Token åŠ å¯†/è§£å¯†
- `src/api/viewer.ts` (æˆ– routes/viewer.ts) â€“ Viewer è·¯ç”±å®šç¾©

### å‰ç«¯æª”æ¡ˆæ¸…å–®ï¼ˆé è¨ˆä¿®æ”¹/æ–°å¢ï¼‰

#### ä¿®æ”¹ï¼š
- `src/app/page.tsx` (Landing) â€“ æ–°å¢ã€Œè§€çœ¾ç™»å…¥ã€é¸é …
- `src/features/auth/hooks/useAuthSession.ts` â€“ æ”¯æ´ role å€åˆ†

#### æ–°å¢ï¼š
- `src/app/dashboard/viewer/page.tsx` â€“ è§€çœ¾å„€è¡¨æ¿é¦–é 
- `src/app/dashboard/viewer/[channelId]/page.tsx` â€“ é »é“çµ±è¨ˆé é¢
- `src/app/auth/viewer/login.tsx` â€“ é‡å°é é¢ï¼ˆå¯é¸ï¼Œé€šå¸¸ç›´æ¥ redirectï¼‰
- `src/app/auth/viewer/callback.tsx` â€“ OAuth å›èª¿è™•ç†
- `src/app/auth/viewer/consent.tsx` â€“ éš±ç§åŒæ„é é¢
- `src/app/auth/viewer/logout.tsx` â€“ ç™»å‡ºç¢ºèªé é¢
- `src/lib/api/__mocks__/viewer.ts` â€“ Mock è³‡æ–™
- `src/features/viewer-dashboard/components/ChannelSelector.tsx` â€“ é »é“é¸æ“‡å™¨
- `src/features/viewer-dashboard/components/ViewerHeader.tsx` â€“ è§€çœ¾å„€è¡¨æ¿ Header

### ç’°å¢ƒè®Šæ•¸éœ€æ±‚

#### å¾Œç«¯æ–°å¢ï¼ˆè‹¥éœ€åŠ å¯†ï¼‰ï¼š
```bash
VIEWER_TOKEN_ENCRYPTION_KEY=<32å­—ç¯€ base64 ç·¨ç¢¼é‡‘é‘°>
```

#### å‰ç«¯ï¼ˆå¯é¸ï¼Œç”¨æ–¼ Mock åˆ‡æ›ï¼‰ï¼š
```bash
NEXT_PUBLIC_USE_MOCK_VIEWER_DATA=false  # ç”Ÿç”¢ç’°å¢ƒè¨­ç‚º false
```

### ç›¸ä¾æ€§èˆ‡å…ˆæ±ºæ¢ä»¶

- âœ… Auth åŸºç¤æ¶æ§‹å·²å®Œæˆï¼ˆEpic 1ï¼‰
- âœ… Viewer è³‡æ–™æ¨¡å‹å·²å®šç¾©æ–¼ Prisma Schema
- â³ EventSub Webhook åŸºç¤å»ºè¨­ï¼ˆåœ¨ Story 2.1 å¾ŒçºŒé€²è¡Œï¼‰

---

## Project Structure Notes

```
backend/
  src/
    modules/
      auth/
        auth.controller.ts       â† ä¿®æ”¹ï¼šåŠ  /auth/viewer/* ç«¯é»
        auth.service.ts          â† ä¿®æ”¹ï¼šåŠ  handleViewerTwitchCallback()
        jwt.utils.ts             â† ä¿®æ”¹ï¼šrole æ¬„ä½
      
      viewer/                    â† æ–°å¢æ¨¡çµ„
        viewer.controller.ts
        viewer.service.ts
        viewer.repository.ts
      
      ingest/                    â† Story 2.2+ æ‰å¯¦ä½œ EventSub

    utils/
      crypto.utils.ts            â† æ–°å¢ï¼šToken åŠ å¯†

frontend/
  src/
    app/
      page.tsx                   â† ä¿®æ”¹ï¼šåŠ è§€çœ¾ç™»å…¥æŒ‰éˆ•
      auth/
        viewer/
          callback.tsx           â† æ–°å¢ï¼šOAuth callback
          consent.tsx            â† æ–°å¢ï¼šéš±ç§åŒæ„
          logout.tsx             â† æ–°å¢ï¼šç™»å‡ºé é¢
      
      dashboard/
        viewer/
          page.tsx               â† æ–°å¢ï¼šå„€è¡¨æ¿é¦–é 
          [channelId]/page.tsx   â† æ–°å¢ï¼šé »é“çµ±è¨ˆé é¢
    
    features/
      viewer-dashboard/          â† æ–°å¢ç›®éŒ„
        components/
          ChannelSelector.tsx
          ViewerHeader.tsx

    lib/
      api/
        __mocks__/
          viewer.ts              â† æ–°å¢ï¼šMock è³‡æ–™
```

---

## Definition of Done

- [ ] æ‰€æœ‰ AC éƒ½å·²å¯¦ä½œ
- [ ] æ‰€æœ‰ Tasks éƒ½å·²å®Œæˆï¼ˆcheckbox æ¨™è¨˜ [x]ï¼‰
- [ ] å¾Œç«¯å–®å…ƒæ¸¬è©¦é€šéç‡ 100%
- [ ] å‰ç«¯çµ„ä»¶æ¸¬è©¦é€šéç‡ 100%
- [ ] E2E æ¸¬è©¦æ¶µè“‹ç™»å…¥æµç¨‹
- [ ] ç„¡ ESLint éŒ¯èª¤
- [ ] ç„¡ TypeScript é¡å‹éŒ¯èª¤
- [ ] éš±ç§åŒæ„é é¢æ–‡æ¡ˆå·²ç”±ç”¢å“ç¢ºèª
- [ ] API æ–‡ä»¶å·²æ›´æ–°
- [ ] ç¨‹å¼ç¢¼å·²æäº¤è‡³ gitï¼ŒPR å·²é€šéå¯©æŸ¥

