# Story 2.3: è§€çœ¾ç•™è¨€èˆ‡äº’å‹•çµ±è¨ˆ

## Status

- ğŸ“‹ Draft
- å»ºç«‹æ—¥æœŸï¼š2025-12-11
- ä¾è³´ï¼šStory 2.1ï¼ˆè§€çœ¾ç™»å…¥ï¼‰ã€Story 2.2ï¼ˆè§€çœ‹æ™‚æ•¸çµ±è¨ˆï¼‰

## Related Documents

- `docs/epic-2-viewer-engagement-analytics.md#4-user-stories` â€“ Story 2.3 åŸå§‹éœ€æ±‚èƒŒæ™¯
- `docs/stories/2.1.viewer-login-and-authorization.md` â€“ å‰ç½® Storyï¼ˆOAuthï¼‰
- `docs/stories/2.2.viewer-watch-time-and-interaction-stats.md` â€“ å‰ç½® Storyï¼ˆåœ–è¡¨æ¶æ§‹ï¼‰
- `docs/architecture/fullstack-architecture.md` â€“ æŠ€è¡“æ¶æ§‹åƒè€ƒ

## Story

**As a** é‡åº¦è§€çœ¾ï¼ˆæ´»èºæ–¼æŸå¯¦æ³ä¸»é »é“çš„èŠå¤©å®¤ï¼‰  
**I want** æŸ¥çœ‹è‡ªå·±åœ¨è©²é »é“çš„ç•™è¨€æ•¸é‡ã€äº’å‹•é¡å‹çµ±è¨ˆèˆ‡æ´»èºè¶¨å‹¢  
**so that** æˆ‘èƒ½é‡åŒ–è‡ªå·±çš„ç¤¾ç¾¤åƒèˆ‡åº¦ï¼Œä¸¦äº†è§£èˆ‡é »é“çš„äº’å‹•æ¨¡å¼ã€‚

## Acceptance Criteria

### AC 1: ç•™è¨€çµ±è¨ˆå¡ç‰‡å±•ç¤º
- Given è§€çœ¾å·²ç™»å…¥ä¸¦é¸æ“‡ç‰¹å®šå¯¦æ³ä¸»é »é“
- When è§€çœ¾æŸ¥çœ‹ã€Œäº’å‹•çµ±è¨ˆã€é ç±¤æˆ–å€å¡Š
- Then ç³»çµ±æ‡‰é¡¯ç¤ºä»¥ä¸‹çµ±è¨ˆå¡ç‰‡ï¼š
  - **ç¸½ç•™è¨€æ•¸**ï¼ˆé¸å®šæ™‚é–“ç¯„åœå…§ï¼‰
  - **å¹³å‡æ¯æ¬¡ç›´æ’­ç•™è¨€æ•¸**
  - **æœ€æ´»èºæ—¥æœŸ**ï¼ˆç•™è¨€æ•¸æœ€å¤šçš„é‚£å¤©ï¼Œå«æ—¥æœŸèˆ‡æ•¸é‡ï¼‰
  - **æœ€è¿‘ç•™è¨€æ™‚é–“**ï¼ˆç›¸å°æ™‚é–“ï¼Œå¦‚ã€Œ3 å°æ™‚å‰ã€ï¼‰
- And å¡ç‰‡é ‚éƒ¨é¡¯ç¤ºæ‰€é¸æ™‚é–“ç¯„åœï¼ˆèˆ‡ Story 2.2 çš„é¸æ“‡å™¨åŒæ­¥ï¼‰

### AC 2: äº’å‹•é¡å‹ç´°åˆ†çµ±è¨ˆï¼ˆå®Œæ•´åœ–è­œï¼‰
- Given ç³»çµ±å·²æ”¶é›†è§€çœ¾çš„èŠå¤©äº’å‹•è³‡æ–™
- When è§€çœ¾æŸ¥çœ‹äº’å‹•ç´°åˆ†å€å¡Š
- Then ç³»çµ±æ‡‰é¡¯ç¤ºä»¥ä¸‹äº’å‹•é¡å‹çš„æ•¸é‡èˆ‡ä½”æ¯”ï¼š
  - **ä¸€èˆ¬æ–‡å­—è¨Šæ¯**ï¼ˆCHAT_MESSAGEï¼‰
  - **è¨‚é–±é€šçŸ¥**ï¼ˆSUBSCRIPTIONï¼‰
  - **è´ŠåŠ©/Bits**ï¼ˆCHEERï¼‰
  - **è´ˆé€è¨‚é–±**ï¼ˆGIFT_SUBSCRIPTIONï¼‰
  - **Raid åƒèˆ‡**ï¼ˆRAIDï¼‰
  - **æŠ•ç¥¨åƒèˆ‡**ï¼ˆPOLL_VOTEï¼‰*ï¼ˆè‹¥ Twitch API æ”¯æ´ï¼‰*
- And ä»¥ç’°å½¢åœ–ï¼ˆPie Chartï¼‰æˆ–æ°´å¹³æ¢å½¢åœ–å±•ç¤ºå„é¡å‹ä½”æ¯”
- And é»æ“Šä»»ä¸€é¡å‹ï¼Œå¯å±•é–‹è©²é¡å‹çš„è©³ç´°è³‡è¨Šï¼ˆå¦‚ç¸½é‡‘é¡ã€æœ€å¤§å–®ç­†ç­‰ï¼‰

**é™åˆ¶èªªæ˜**ï¼šå—é™æ–¼ `chat:read` OAuth scopeï¼Œéƒ¨åˆ†é€²éšäº’å‹•ï¼ˆå¦‚ã€Œè¢«ä»–äºº @ æåŠã€ã€ã€Œä»–äººå›è¦†ä½ çš„è¨Šæ¯ã€ï¼‰ç„¡æ³•åœ¨æ­¤ Story å¯¦ä½œã€‚å¯æ¨™è¨˜ç‚ºæœªä¾†å‡ç´šé …ç›®ï¼ˆéœ€é¡å¤– scopeï¼‰ã€‚

### AC 3: æ¯æ—¥ç•™è¨€è¶¨å‹¢æŸ±ç‹€åœ–
- Given æ™‚é–“ç¯„åœå·²ç¢ºå®šï¼ˆèˆ‡ Story 2.2 å…±ç”¨é¸æ“‡å™¨ï¼‰
- When ç³»çµ±å·²èšåˆè©²ç¯„åœå…§çš„æ¯æ—¥ç•™è¨€æ•¸
- Then ç³»çµ±æ‡‰é¡¯ç¤º Recharts BarChartï¼š
  - **X è»¸**ï¼šæ—¥æœŸï¼ˆæ ¼å¼ MMM DDï¼‰
  - **Y è»¸**ï¼šç•™è¨€æ•¸é‡
  - **æŸ±ç‹€åœ–**ï¼šæ¯æ—¥ç•™è¨€æ•¸ï¼ˆå¯åˆ†å±¤å †ç–Šé¡¯ç¤ºä¸åŒäº’å‹•é¡å‹ï¼‰
  - **äº’å‹• Tooltip**ï¼šé¡¯ç¤ºæ—¥æœŸã€ç¸½ç•™è¨€æ•¸ã€å„é¡å‹ç´°åˆ†
  - **éŸ¿æ‡‰å¼**ï¼šæ‰‹æ©Ÿè‡ªå‹•èª¿æ•´å¯¬åº¦èˆ‡å­—é«”å¤§å°

### AC 4: TMI.js èŠå¤©ç›£è½ï¼ˆè³‡æ–™æ”¶é›†å±¤ï¼‰
- Given è§€çœ¾å·²æˆæ¬Š `chat:read` scope
- When è§€çœ¾è¿½è¹¤çš„å¯¦æ³ä¸»é–‹æ’­
- Then å¾Œç«¯æ‡‰ï¼š
  - ä½¿ç”¨ TMI.js é€£æ¥è©²é »é“çš„ Twitch IRC èŠå¤©å®¤
  - ç›£è½è§€çœ¾æœ¬äººç™¼é€çš„æ‰€æœ‰è¨Šæ¯ï¼ˆfilter by usernameï¼‰
  - è§£æè¨Šæ¯å…§å®¹ï¼štimestamp, message, channel, badgesï¼ˆè¨‚é–±è€…å¾½ç« ç­‰ï¼‰
  - å³æ™‚å¯«å…¥ `ViewerChannelMessage` è¡¨ï¼ˆè©³ç´°è¨˜éŒ„ï¼‰
  - æ¯å°æ™‚èšåˆè‡³ `ViewerChannelMessageDailyAgg` è¡¨
- And è‹¥å¯¦æ³ä¸»é›¢ç·šï¼Œæ‡‰åœæ­¢ç›£è½ï¼ˆç¯€çœè³‡æºï¼‰
- And ç›£è½æ‡‰å…·å®¹éŒ¯æ€§ï¼ˆæ–·ç·šè‡ªå‹•é‡é€£ï¼Œæœ€å¤šé‡è©¦ 3 æ¬¡ï¼‰

### AC 5: æ··åˆè³‡æ–™å­˜å„²ï¼ˆè©³ç´°è¡¨ + èšåˆè¡¨ï¼‰
- Given ç³»çµ±éœ€è¦æ”¯æ´ã€ŒæŸ¥è©¢æ­·å²ç•™è¨€ã€èˆ‡ã€Œå¿«é€Ÿçµ±è¨ˆã€
- When è¨­è¨ˆè³‡æ–™æ¨¡å‹æ™‚
- Then æ‡‰å»ºç«‹å…©å¼µè¡¨ï¼š
  
  **è©³ç´°è¡¨ï¼šViewerChannelMessage**
  ```prisma
  model ViewerChannelMessage {
    id: String @id @default(cuid())
    viewerId: String
    channelId: String
    messageText: String
    messageType: String  // "CHAT", "SUBSCRIPTION", "CHEER", etc.
    timestamp: DateTime
    badges: Json?         // è¨‚é–±è€…ã€ç‰ˆä¸»ç­‰å¾½ç« 
    emotesUsed: Json?     // ä½¿ç”¨çš„è¡¨æƒ…ç¬¦è™Ÿ
    bitsAmount: Int?      // è‹¥ç‚º Cheerï¼Œé‡‘é¡
    createdAt: DateTime @default(now())
    
    @@index([viewerId, channelId, timestamp])
  }
  ```
  
  **èšåˆè¡¨ï¼šViewerChannelMessageDailyAgg**
  ```prisma
  model ViewerChannelMessageDailyAgg {
    id: String @id @default(cuid())
    viewerId: String
    channelId: String
    date: DateTime @db.Date
    totalMessages: Int
    chatMessages: Int
    subscriptions: Int
    cheers: Int
    giftSubs: Int
    raids: Int
    totalBits: Int?
    updatedAt: DateTime @updatedAt
    
    @@unique([viewerId, channelId, date])
    @@index([viewerId])
    @@index([channelId])
  }
  ```

### AC 6: èšåˆ API ç«¯é»
- Given å‰ç«¯è«‹æ±‚äº’å‹•çµ±è¨ˆ
- When ç™¼é€ `GET /api/viewer/{viewerId}/channels/{channelId}/message-stats?startDate=YYYY-MM-DD&endDate=YYYY-MM-DD`
- Then ç³»çµ±æ‡‰è¿”å›ï¼š
  ```json
  {
    "channelId": "string",
    "channelName": "string",
    "timeRange": {
      "startDate": "2025-11-12",
      "endDate": "2025-12-11"
    },
    "summary": {
      "totalMessages": 342,
      "avgMessagesPerStream": 28,
      "mostActiveDate": "2025-12-05",
      "mostActiveDateCount": 87,
      "lastMessageAt": "2025-12-11T10:30:00Z"
    },
    "interactionBreakdown": {
      "chatMessages": 300,
      "subscriptions": 2,
      "cheers": 15,
      "giftSubs": 1,
      "raids": 0,
      "totalBits": 1500
    },
    "dailyBreakdown": [
      {
        "date": "2025-11-12",
        "totalMessages": 25,
        "chatMessages": 23,
        "cheers": 2
      }
      // ... æ¯æ—¥è³‡æ–™
    ]
  }
  ```

### AC 7: éš±ç§èˆ‡æˆæ¬Š
- Given è§€çœ¾æŸ¥è©¢äº’å‹•çµ±è¨ˆ
- When è«‹æ±‚åŒ…å« viewerId
- Then ç³»çµ±æ‡‰é©—è­‰ï¼š
  - JWT Token ä¸­çš„ twitchUserId ç¬¦åˆè«‹æ±‚çš„ viewerId
  - è‹¥ä¸ç¬¦ï¼Œè¿”å› HTTP 403
- And è§€çœ¾æ‡‰èƒ½åœ¨è¨­å®šä¸­ã€Œæš«åœæ”¶é›†ã€æˆ–ã€Œæ¸…é™¤æ­·å²ç•™è¨€ã€
- And åˆªé™¤æ“ä½œæ‡‰åŒæ™‚æ¸…é™¤è©³ç´°è¡¨èˆ‡èšåˆè¡¨

### AC 8: æ•ˆèƒ½èˆ‡è³‡æºæ§åˆ¶
- Given TMI.js éœ€è¦æŒçºŒç›£è½å¤šå€‹é »é“
- When ç³»çµ±ç›£è½é »é“æ•¸ > 100
- Then æ‡‰å¯¦æ–½ä»¥ä¸‹æ§åˆ¶ï¼š
  - æŒ‰å„ªå…ˆç´šç›£è½ï¼ˆæ´»èºåº¦é«˜çš„è§€çœ¾å„ªå…ˆï¼‰
  - é›¢ç·šé »é“è‡ªå‹•åœæ­¢ç›£è½
  - å–®å€‹ TMI.js å¯¦ä¾‹æœ€å¤šç›£è½ 50 å€‹é »é“
  - è¶…éå‰‡å•Ÿå‹•å¤šå¯¦ä¾‹ï¼ˆæ°´å¹³æ“´å±•ï¼‰
- And ç›£è½ç‹€æ…‹æ‡‰è¨˜éŒ„æ–¼ç›£æ§ç³»çµ±ï¼ˆå¥åº·æª¢æŸ¥ï¼‰

---

## Tasks / Subtasks

### Task 1ï¼ˆAC 4, 5ï¼‰å¾Œç«¯ï¼šTMI.js æ•´åˆèˆ‡è³‡æ–™æ”¶é›†

- [ ] Task 1.1: å®‰è£èˆ‡é…ç½® TMI.js
  - [x] æ–°å¢ä¾è³´ï¼š`npm install tmi.js @types/tmi.js`
  - [x] æ–°å¢ç’°å¢ƒè®Šæ•¸ï¼š
    ```bash
    TWITCH_BOT_USERNAME=your_bot_username  # å¯ç”¨è§€çœ¾è‡ªå·±çš„å¸³è™Ÿ
    TWITCH_BOT_OAUTH_TOKEN=oauth:xxx       # è§€çœ¾çš„ Access Token
    ```

- [ ] Task 1.2: å»ºç«‹ Twitch Chat ç›£è½æœå‹™
  - [x] æ–°å¢ `src/services/twitch-chat.service.ts`
  - [x] å¯¦ä½œåŠŸèƒ½ï¼š
    - `connectToChannel(channelName: string)` â€“ é€£æ¥é »é“ IRC
    - `disconnectFromChannel(channelName: string)` â€“ æ–·é–‹é€£æ¥
    - `handleMessage(channel, userstate, message)` â€“ è¨Šæ¯è™•ç†å™¨
    - `reconnect()` â€“ æ–·ç·šé‡é€£é‚è¼¯ï¼ˆæœ€å¤š 3 æ¬¡ï¼‰
  - [x] éæ¿¾è¨Šæ¯ï¼šåªä¿å­˜ç›®æ¨™è§€çœ¾ç™¼é€çš„è¨Šæ¯

- [ ] Task 1.3: å¯¦ä½œè¨Šæ¯è§£æèˆ‡åˆ†é¡
  - [x] æ–°å¢ `src/utils/message-parser.ts`
  - [x] è§£æ TMI.js `userstate` ç‰©ä»¶ï¼š
    - æå– badgesï¼ˆè¨‚é–±è€…ã€ç‰ˆä¸»ã€VIPï¼‰
    - è­˜åˆ¥è¨Šæ¯é¡å‹ï¼ˆCHAT, SUBSCRIPTION, CHEERï¼‰
    - æå– Bits é‡‘é¡ï¼ˆè‹¥æœ‰ï¼‰
    - æå–ä½¿ç”¨çš„ Emotes
  - [x] è¿”å›æ¨™æº–åŒ–çš„è¨Šæ¯ç‰©ä»¶

- [ ] Task 1.4: å»ºç«‹ Prisma Migrationï¼ˆè³‡æ–™è¡¨ï¼‰
  - [x] æ–°å¢ `ViewerChannelMessage` æ¨¡å‹
  - [x] æ–°å¢ `ViewerChannelMessageDailyAgg` æ¨¡å‹
  - [x] åŸ·è¡Œ `prisma migrate dev --name add_viewer_messages`

- [ ] Task 1.5: è¨Šæ¯å„²å­˜é‚è¼¯
  - [x] æ–°å¢ `src/modules/viewer/viewer-message.repository.ts`
  - [x] å¯¦ä½œ `saveMessage(messageData)` â€“ å¯«å…¥è©³ç´°è¡¨
  - [x] å¯¦ä½œ `aggregateDailyMessages()` â€“ æ¯å°æ™‚èšåˆè‡³ DailyAgg è¡¨
  - [x] ä½¿ç”¨ Upsert é¿å…é‡è¤‡èšåˆ

- [ ] Task 1.6: å®šæ™‚èšåˆä»»å‹™
  - [x] æ–°å¢ Cron Jobï¼šæ¯å°æ™‚åŸ·è¡Œ `aggregateDailyMessages()`
  - [x] è¨˜éŒ„åŸ·è¡Œæ—¥èªŒèˆ‡éŒ¯èª¤ç‹€æ…‹

### Task 2ï¼ˆAC 6ï¼‰å¾Œç«¯ï¼šäº’å‹•çµ±è¨ˆ API

- [ ] Task 2.1: å»ºç«‹çµ±è¨ˆæŸ¥è©¢ç«¯é»
  - [x] æ–°å¢ `src/modules/viewer/viewer-message-stats.controller.ts`
  - [x] å¯¦ä½œ `GET /api/viewer/:viewerId/channels/:channelId/message-stats`
  - [x] åƒæ•¸é©—è­‰ï¼šstartDate, endDateï¼ˆèˆ‡ Story 2.2 ä¸€è‡´ï¼‰

- [ ] Task 2.2: çµ±è¨ˆæ¥­å‹™é‚è¼¯
  - [x] æ–°å¢ `src/modules/viewer/viewer-message-stats.service.ts`
  - [x] æŸ¥è©¢ `ViewerChannelMessageDailyAgg` è¡¨
  - [x] è¨ˆç®—ï¼š
    - ç¸½ç•™è¨€æ•¸ã€å¹³å‡æ¯æ¬¡ç›´æ’­ç•™è¨€ã€æœ€æ´»èºæ—¥æœŸ
    - äº’å‹•é¡å‹ç´°åˆ†ï¼ˆchat, sub, cheer, etc.ï¼‰
    - æ¯æ—¥ç´°åˆ†è³‡æ–™ï¼ˆç”¨æ–¼åœ–è¡¨ï¼‰

- [ ] Task 2.3: æˆæ¬Šæª¢æŸ¥
  - [x] é©—è­‰ JWT Token
  - [x] ç¢ºèª viewerId ç¬¦åˆ Token ä¸­çš„ twitchUserId

### Task 3ï¼ˆAC 1, 3ï¼‰å‰ç«¯ï¼šç•™è¨€çµ±è¨ˆå¡ç‰‡èˆ‡åœ–è¡¨

- [ ] Task 3.1: å»ºç«‹ç•™è¨€çµ±è¨ˆæ‘˜è¦å¡ç‰‡
  - [x] æ–°å¢ `src/features/viewer-dashboard/components/MessageStatsSummary.tsx`
  - [x] é¡¯ç¤º 4 å€‹æŒ‡æ¨™å¡ç‰‡ï¼š
    - ç¸½ç•™è¨€æ•¸
    - å¹³å‡æ¯æ¬¡ç›´æ’­ç•™è¨€æ•¸
    - æœ€æ´»èºæ—¥æœŸ
    - æœ€è¿‘ç•™è¨€æ™‚é–“
  - [x] Loading èˆ‡ Error ç‹€æ…‹

- [ ] Task 3.2: å»ºç«‹æ¯æ—¥ç•™è¨€æŸ±ç‹€åœ–
  - [x] æ–°å¢ `src/features/viewer-dashboard/components/MessageTrendChart.tsx`
  - [x] ä½¿ç”¨ Recharts BarChartï¼š
    ```tsx
    <BarChart data={dailyBreakdown}>
      <CartesianGrid strokeDasharray="3 3" />
      <XAxis dataKey="date" tickFormatter={formatDate} />
      <YAxis label={{ value: 'ç•™è¨€æ•¸', angle: -90, position: 'insideLeft' }} />
      <Tooltip content={<CustomTooltip />} />
      <Bar dataKey="totalMessages" fill="#8b5cf6" />
    </BarChart>
    ```

- [ ] Task 3.3: æ•´åˆè‡³é »é“çµ±è¨ˆé é¢
  - [x] ä¿®æ”¹ `src/app/dashboard/viewer/[channelId]/page.tsx`
  - [x] æ–°å¢ã€Œäº’å‹•çµ±è¨ˆã€é ç±¤æˆ–å€å¡Š
  - [x] å¼•å…¥ MessageStatsSummary èˆ‡ MessageTrendChart
  - [x] èˆ‡ Story 2.2 çš„æ™‚é–“ç¯„åœé¸æ“‡å™¨åŒæ­¥

### Task 4ï¼ˆAC 2ï¼‰å‰ç«¯ï¼šäº’å‹•é¡å‹ç´°åˆ†åœ–è¡¨

- [ ] Task 4.1: å»ºç«‹äº’å‹•é¡å‹åˆ†ä½ˆåœ–
  - [x] æ–°å¢ `src/features/viewer-dashboard/components/InteractionBreakdownChart.tsx`
  - [x] ä½¿ç”¨ Recharts PieChart æˆ– BarChartï¼ˆæ°´å¹³æ¢å½¢ï¼‰
  - [x] é¡¯ç¤ºå„äº’å‹•é¡å‹ä½”æ¯”
  - [x] é»æ“Šå±•é–‹è©³ç´°è³‡è¨Šï¼ˆä½¿ç”¨ Modal æˆ– Accordionï¼‰

- [ ] Task 4.2: è©³ç´°è³‡è¨Šå±•é–‹é‚è¼¯
  - [x] å»ºç«‹ `InteractionDetailModal.tsx`
  - [x] é¡¯ç¤ºï¼š
    - è¨‚é–±ï¼šæ¬¡æ•¸ã€æœ€è¿‘è¨‚é–±æ—¥æœŸ
    - Cheersï¼šç¸½ Bitsã€æœ€å¤§å–®ç­†ã€å¹³å‡
    - è´ˆé€è¨‚é–±ï¼šæ¬¡æ•¸ã€å—è´ˆè€…ï¼ˆè‹¥æœ‰è¨˜éŒ„ï¼‰

### Task 5ï¼ˆAC 7ï¼‰éš±ç§æ§åˆ¶åŠŸèƒ½

- [ ] Task 5.1: å»ºç«‹éš±ç§è¨­å®š API
  - [x] æ–°å¢ `POST /api/viewer/:viewerId/privacy/pause-collection`
  - [x] æ–°å¢ `POST /api/viewer/:viewerId/privacy/clear-messages`
  - [x] æ¸…é™¤æ“ä½œæ‡‰åˆªé™¤ï¼š
    - ViewerChannelMessageï¼ˆè©³ç´°è¨˜éŒ„ï¼‰
    - ViewerChannelMessageDailyAggï¼ˆèšåˆè³‡æ–™ï¼‰

- [ ] Task 5.2: å‰ç«¯éš±ç§æ§åˆ¶é é¢
  - [x] ä¿®æ”¹ `src/app/dashboard/viewer/settings/page.tsx`
  - [x] æ–°å¢ã€Œæš«åœæ”¶é›†ç•™è¨€ã€é–‹é—œ
  - [x] æ–°å¢ã€Œæ¸…é™¤æ­·å²ç•™è¨€ã€æŒ‰éˆ•ï¼ˆéœ€äºŒæ¬¡ç¢ºèªï¼‰

### Task 6ï¼ˆAC 8ï¼‰ç›£è½è³‡æºæ§åˆ¶

- [ ] Task 6.1: é »é“ç›£è½ç®¡ç†ç³»çµ±
  - [x] æ–°å¢ `src/services/channel-listener-manager.ts`
  - [x] è¿½è¹¤ç•¶å‰ç›£è½çš„é »é“æ¸…å–®
  - [x] å¯¦ä½œå„ªå…ˆç´šé‚è¼¯ï¼ˆæ´»èºè§€çœ¾å„ªå…ˆï¼‰
  - [x] è‡ªå‹•åœæ­¢é›¢ç·šé »é“ç›£è½

- [ ] Task 6.2: å¤šå¯¦ä¾‹æ”¯æ´ï¼ˆå¯é¸ï¼Œè‹¥éœ€æ“´å±•ï¼‰
  - [x] é…ç½®å¤šå€‹ TMI.js å¯¦ä¾‹ï¼ˆæ¯å€‹æœ€å¤š 50 é »é“ï¼‰
  - [x] ä½¿ç”¨ Redis æˆ–è³‡æ–™åº«è¨˜éŒ„ã€Œå“ªå€‹å¯¦ä¾‹ç›£è½å“ªäº›é »é“ã€
  - [x] è² è¼‰å‡è¡¡é‚è¼¯

- [ ] Task 6.3: ç›£æ§èˆ‡å¥åº·æª¢æŸ¥
  - [x] æ–°å¢ `GET /api/admin/chat-listeners/status`
  - [x] è¿”å›ï¼šç•¶å‰ç›£è½é »é“æ•¸ã€å¯¦ä¾‹ç‹€æ…‹ã€éŒ¯èª¤ç‡

### Task 7: æ¸¬è©¦èˆ‡ QA

- [ ] Task 7.1: å–®å…ƒæ¸¬è©¦ â€“ TMI.js æœå‹™
  - [x] Mock TMI.js å®¢æˆ¶ç«¯
  - [x] æ¸¬è©¦è¨Šæ¯è§£æé‚è¼¯
  - [x] æ¸¬è©¦é‡é€£é‚è¼¯

- [ ] Task 7.2: æ•´åˆæ¸¬è©¦ â€“ API ç«¯é»
  - [x] æ¸¬è©¦ message-stats API
  - [x] æ¸¬è©¦æˆæ¬Šæª¢æŸ¥

- [ ] Task 7.3: E2E æ¸¬è©¦ â€“ Playwright
  - [x] æ¸¬è©¦è§€çœ¾æŸ¥çœ‹äº’å‹•çµ±è¨ˆ
  - [x] æ¸¬è©¦æ™‚é–“ç¯„åœåˆ‡æ›
  - [x] æ¸¬è©¦äº’å‹•é¡å‹å±•é–‹

- [ ] Task 7.4: æ•ˆèƒ½æ¸¬è©¦
  - [x] æ¸¬è©¦ 100+ å€‹é »é“åŒæ™‚ç›£è½
  - [x] é©—è­‰èšåˆæŸ¥è©¢ < 100ms

### Task 8: æ–‡ä»¶èˆ‡äº¤ä»˜

- [ ] Task 8.1: æ›´æ–° API æ–‡ä»¶
  - [x] æ–°å¢ message-stats API çš„ OpenAPI è¦ç¯„

- [ ] Task 8.2: TMI.js é…ç½®æ–‡ä»¶
  - [x] è¨˜éŒ„ç’°å¢ƒè®Šæ•¸è¨­å®š
  - [x] è¨˜éŒ„ç›£è½é‚è¼¯èˆ‡é™åˆ¶

---

## Dev Notes

### æŠ€è¡“æ±ºç­–è¨˜éŒ„

**æ±ºç­– 1ï¼šè³‡æ–™ä¾†æº**
- âœ… é¸æ“‡ï¼š**TMI.js (Twitch IRC å®¢æˆ¶ç«¯ï¼Œæ–¹æ¡ˆ B)**
- ç†ç”±ï¼šèƒ½å³æ™‚æ”¶é›†èŠå¤©è¨Šæ¯ï¼Œä¸”å¯å–å¾—æ­·å²è¨˜éŒ„ï¼ˆé€£æ¥å¾Œçš„æ‰€æœ‰è¨Šæ¯ï¼‰
- é™åˆ¶ï¼šåƒ…èƒ½ç›£è½ã€Œç›®å‰é€£æ¥å¾Œã€çš„è¨Šæ¯ï¼Œç„¡æ³•å›æº¯éå»ï¼ˆTwitch API å·²æ£„ç”¨æ­·å²æŸ¥è©¢ï¼‰
- å¯¦ä½œï¼šä½¿ç”¨è§€çœ¾çš„ OAuth Token é€£æ¥ IRC

**æ±ºç­– 2ï¼šäº’å‹•é¡å‹ç´°åˆ†**
- âœ… é¸æ“‡ï¼š**å®Œæ•´äº’å‹•åœ–è­œï¼ˆæ–¹æ¡ˆ Cï¼‰**
- ç†ç”±ï¼šæä¾›æœ€è±å¯Œçš„çµ±è¨ˆç¶­åº¦ï¼Œå€åˆ†ç•™è¨€ã€è¨‚é–±ã€Cheersã€è´ˆé€è¨‚é–±ç­‰
- å¯¦ä½œé›£åº¦ï¼šä¸­ç­‰ï¼ˆéœ€è§£æ TMI.js çš„ userstate èˆ‡ badgesï¼‰
- æ¬Šè¡¡ï¼šå—é™æ–¼ `chat:read` scopeï¼Œç„¡æ³•è¿½è¸ªã€Œè¢«ä»–äºº @ æåŠã€ï¼ˆéœ€é¡å¤– scopeï¼Œç•™å¾…æœªä¾†å‡ç´šï¼‰

**æ±ºç­– 3ï¼šåœ–è¡¨å±•ç¤º**
- âœ… é¸æ“‡ï¼š**ç°¡å–®æŸ±ç‹€åœ–ï¼ˆæ–¹æ¡ˆ Aï¼‰**
- ç†ç”±ï¼šèˆ‡ Story 2.2 çš„æŠ˜ç·šåœ–æ­é…ï¼Œè¦–è¦ºä¸€è‡´æ€§å¥½
- æœªä¾†å¯å‡ç´šï¼šåˆ†å±¤æŸ±ç‹€åœ–ï¼ˆå †ç–Šä¸åŒäº’å‹•é¡å‹ï¼‰

**æ±ºç­– 4ï¼šè³‡æ–™å­˜å„²**
- âœ… é¸æ“‡ï¼š**æ··åˆæ–¹æ¡ˆï¼ˆè©³ç´°è¡¨ + èšåˆè¡¨ï¼Œæ–¹æ¡ˆ Cï¼‰**
- ç†ç”±ï¼š
  - è©³ç´°è¡¨ï¼šæ”¯æ´ã€ŒæŸ¥è©¢æ­·å²ç•™è¨€å…§å®¹ã€ï¼ˆæœªä¾†åŠŸèƒ½ï¼‰
  - èšåˆè¡¨ï¼šå¿«é€Ÿçµ±è¨ˆæŸ¥è©¢ï¼ˆ< 100msï¼‰
- å­˜å„²æˆæœ¬ï¼šä¸­ç­‰ï¼ˆä½†å¯è¨­å®šä¿ç•™æœŸé™ï¼Œå¦‚åƒ…ä¿å­˜ 90 å¤©è©³ç´°è¨˜éŒ„ï¼‰

**æ±ºç­– 5ï¼šOAuth æ¬Šé™**
- âœ… é¸æ“‡ï¼š**ä½¿ç”¨æ—¢æœ‰ chat:readï¼ˆæ–¹æ¡ˆ Aï¼‰**
- ç†ç”±ï¼šStory 2.1 å·²ç²å¾—æ­¤ scopeï¼Œç„¡éœ€é‡æ–°æˆæ¬Š
- é™åˆ¶ï¼šç„¡æ³•å¯¦ä½œã€Œè¢«ä»–äºº @ æåŠã€ã€ã€Œä»–äººå›è¦†ä½ ã€çš„çµ±è¨ˆï¼ˆéœ€ `user:read:chat` æˆ–æ›´é«˜æ¬Šé™ï¼‰
- æœªä¾†å‡ç´šè·¯å¾‘ï¼šStory 2.4 æˆ– 2.5 å¯å¢åŠ é€²éšæ¬Šé™

### èˆ‡ Epic 1ã€Story 2.2 çš„è¤‡ç”¨é»

1. **API æ¶æ§‹**
   - è¤‡ç”¨ Controller â†’ Service â†’ Repository æ¨¡å¼
   - è¤‡ç”¨ JWT èªè­‰ä¸­ä»‹è»Ÿé«”
   - è¤‡ç”¨æ™‚é–“ç¯„åœé¸æ“‡å™¨ï¼ˆTimeRangeSelectorï¼‰

2. **å‰ç«¯**
   - è¤‡ç”¨ Recharts åœ–è¡¨åº«
   - è¤‡ç”¨ Tailwind CSS è¨­è¨ˆç³»çµ±
   - è¤‡ç”¨ API client

3. **è³‡æ–™èšåˆ**
   - èˆ‡ Story 2.2 çš„ DailyAgg æ¶æ§‹ä¸€è‡´
   - è¤‡ç”¨ Cron Job é‚è¼¯

### æ–°å¼•å…¥çš„æŠ€è¡“/åº«

| åº« | ç”¨é€” | ç‰ˆæœ¬ | å‚™è¨» |
|----|------|------|------|
| `tmi.js` | Twitch IRC å®¢æˆ¶ç«¯ | ^1.8 | ç”¨æ–¼ç›£è½èŠå¤©è¨Šæ¯ |
| `@types/tmi.js` | TypeScript é¡å‹å®šç¾© | Latest | tmi.js çš„å‹åˆ¥æª” |

### è³‡æ–™æµåœ–

```
Twitch IRC èŠå¤©å®¤
    â†“
TMI.js å®¢æˆ¶ç«¯ï¼ˆç›£è½ç›®æ¨™è§€çœ¾è¨Šæ¯ï¼‰
    â†“
Message Parserï¼ˆè§£æé¡å‹ã€Badgesã€Bitsï¼‰
    â†“
ViewerChannelMessageï¼ˆè©³ç´°è¨˜éŒ„è¡¨ï¼‰
    â†“
Cron Jobï¼ˆæ¯å°æ™‚èšåˆï¼‰
    â†“
ViewerChannelMessageDailyAggï¼ˆèšåˆè¡¨ï¼‰
    â†“
API: GET /api/viewer/:viewerId/channels/:channelId/message-stats
    â†“
Frontend: MessageStatsSummaryï¼ˆå¡ç‰‡ï¼‰+ MessageTrendChartï¼ˆåœ–è¡¨ï¼‰+ InteractionBreakdownChartï¼ˆç´°åˆ†ï¼‰
```

### å¾Œç«¯æª”æ¡ˆæ¸…å–®ï¼ˆé è¨ˆä¿®æ”¹/æ–°å¢ï¼‰

#### æ–°å¢ï¼š
- `src/services/twitch-chat.service.ts` â€“ TMI.js ç›£è½æœå‹™
- `src/services/channel-listener-manager.ts` â€“ é »é“ç›£è½ç®¡ç†
- `src/utils/message-parser.ts` â€“ è¨Šæ¯è§£æå·¥å…·
- `src/modules/viewer/viewer-message.repository.ts` â€“ è¨Šæ¯è³‡æ–™åº«æ“ä½œ
- `src/modules/viewer/viewer-message-stats.controller.ts` â€“ çµ±è¨ˆ API æ§åˆ¶å™¨
- `src/modules/viewer/viewer-message-stats.service.ts` â€“ çµ±è¨ˆæ¥­å‹™é‚è¼¯
- `src/jobs/aggregate-daily-messages.job.ts` â€“ èšåˆ Cron Job
- `prisma/migrations/{timestamp}_add_viewer_messages.sql` â€“ è³‡æ–™è¡¨é·ç§»

#### ä¿®æ”¹ï¼š
- `prisma/schema.prisma` â€“ æ–°å¢å…©å€‹è³‡æ–™æ¨¡å‹
- `src/app.ts` æˆ– `main.ts` â€“ åˆå§‹åŒ– TMI.jsã€è¨»å†Š Cron Job

### å‰ç«¯æª”æ¡ˆæ¸…å–®ï¼ˆé è¨ˆä¿®æ”¹/æ–°å¢ï¼‰

#### æ–°å¢ï¼š
- `src/features/viewer-dashboard/components/MessageStatsSummary.tsx` â€“ ç•™è¨€çµ±è¨ˆå¡ç‰‡
- `src/features/viewer-dashboard/components/MessageTrendChart.tsx` â€“ æ¯æ—¥ç•™è¨€æŸ±ç‹€åœ–
- `src/features/viewer-dashboard/components/InteractionBreakdownChart.tsx` â€“ äº’å‹•é¡å‹åˆ†ä½ˆåœ–
- `src/features/viewer-dashboard/components/InteractionDetailModal.tsx` â€“ äº’å‹•è©³æƒ… Modal
- `src/lib/api/viewer-message-stats.ts` â€“ çµ±è¨ˆ API client

#### ä¿®æ”¹ï¼š
- `src/app/dashboard/viewer/[channelId]/page.tsx` â€“ æ•´åˆç•™è¨€çµ±è¨ˆå€å¡Š
- `src/app/dashboard/viewer/settings/page.tsx` â€“ æ–°å¢éš±ç§æ§åˆ¶é¸é …

### ç’°å¢ƒè®Šæ•¸éœ€æ±‚

#### å¾Œç«¯æ–°å¢ï¼š
```bash
# TMI.js é…ç½®
TWITCH_BOT_USERNAME=your_bot_username          # å¯ç”¨è§€çœ¾è‡ªå·±çš„å¸³è™Ÿ
TWITCH_BOT_OAUTH_TOKEN=oauth:your_token        # è§€çœ¾çš„ Access Token

# ç›£è½æ§åˆ¶
MAX_CHANNELS_PER_INSTANCE=50                   # å–®å¯¦ä¾‹æœ€å¤§ç›£è½é »é“æ•¸
MESSAGE_RETENTION_DAYS=90                      # è©³ç´°è¨˜éŒ„ä¿ç•™å¤©æ•¸
AGGREGATION_CRON_EXPRESSION=0 * * * *          # èšåˆ Cron è¡¨é”å¼ï¼ˆæ¯å°æ™‚ï¼‰
```

### ç›¸ä¾æ€§èˆ‡å…ˆæ±ºæ¢ä»¶

- âœ… Story 2.1 å®Œæˆï¼ˆè§€çœ¾ç™»å…¥ã€OAuth `chat:read` scopeï¼‰
- âœ… Story 2.2 å®Œæˆï¼ˆæ™‚é–“ç¯„åœé¸æ“‡å™¨ã€åœ–è¡¨æ¶æ§‹ï¼‰
- â³ Twitch Access Token ç®¡ç†ï¼ˆç”¨æ–¼ TMI.js é€£æ¥ï¼‰
- â³ è³‡æ–™åº«æ”¯æ´ JSON æ¬„ä½ï¼ˆbadges, emotesï¼‰

### OAuth Scope é™åˆ¶èªªæ˜

**ç•¶å‰ Story 2.3 ä½¿ç”¨ `chat:read` scope çš„åŠŸèƒ½ç¯„åœï¼š**

âœ… **å¯å¯¦ç¾ï¼š**
- çµ±è¨ˆè§€çœ¾è‡ªå·±ç™¼é€çš„ç•™è¨€æ•¸é‡
- åˆ†é¡è¨Šæ¯é¡å‹ï¼ˆä¸€èˆ¬èŠå¤©ã€è¨‚é–±ã€Cheersï¼‰
- çµ±è¨ˆ Bits è´ŠåŠ©é‡‘é¡
- è¿½è¹¤è¨‚é–±èˆ‡è´ˆé€è¨‚é–±äº‹ä»¶
- åˆ†æä½¿ç”¨çš„ Emotes

âŒ **ç„¡æ³•å¯¦ç¾ï¼ˆéœ€é¡å¤– scopeï¼‰ï¼š**
- è¿½è¹¤ã€Œä»–äºº @ æåŠä½ ã€ï¼ˆéœ€ Bot ç›£è½æ‰€æœ‰è¨Šæ¯ï¼‰
- çµ±è¨ˆã€Œä½ çš„è¨Šæ¯è¢«ä»–äººå›è¦†æ¬¡æ•¸ã€
- æŸ¥çœ‹ã€Œä½ è¢«ç‰ˆä¸»åˆªé™¤/è¶…æ™‚çš„è¨Šæ¯ã€ï¼ˆéœ€ `moderator:read` scopeï¼‰
- è¿½è¹¤ã€Œä½ åœ¨å…¶ä»–è§€çœ¾è¨Šæ¯ä¸­è¢«æåŠã€

**æœªä¾†å‡ç´šè·¯å¾‘ï¼š**
- Story 2.4 æˆ–ç¨ç«‹ Story å¯è€ƒæ…®å¢åŠ é€²éšäº’å‹•è¿½è¹¤
- éœ€è©•ä¼°æ˜¯å¦å€¼å¾—è¦æ±‚è§€çœ¾é‡æ–°æˆæ¬Šæ›´é«˜æ¬Šé™

---

## Project Structure Notes

```
backend/
  src/
    services/
      twitch-chat.service.ts           â† æ–°å¢ï¼šTMI.js ç›£è½
      channel-listener-manager.ts      â† æ–°å¢ï¼šé »é“ç®¡ç†
    
    utils/
      message-parser.ts                â† æ–°å¢ï¼šè¨Šæ¯è§£æ
    
    modules/
      viewer/
        viewer-message.repository.ts   â† æ–°å¢ï¼šè¨Šæ¯ CRUD
        viewer-message-stats.controller.ts â† æ–°å¢ï¼šçµ±è¨ˆ API
        viewer-message-stats.service.ts â† æ–°å¢ï¼šçµ±è¨ˆé‚è¼¯
    
    jobs/
      aggregate-daily-messages.job.ts  â† æ–°å¢ï¼šèšåˆ Cron

  prisma/
    schema.prisma                      â† ä¿®æ”¹ï¼šæ–°å¢ 2 å€‹è³‡æ–™æ¨¡å‹
    migrations/
      {timestamp}_add_viewer_messages  â† æ–°å¢

frontend/
  src/
    features/
      viewer-dashboard/
        components/
          MessageStatsSummary.tsx      â† æ–°å¢
          MessageTrendChart.tsx        â† æ–°å¢
          InteractionBreakdownChart.tsx â† æ–°å¢
          InteractionDetailModal.tsx   â† æ–°å¢
    
    lib/
      api/
        viewer-message-stats.ts        â† æ–°å¢
    
    app/
      dashboard/
        viewer/
          [channelId]/
            page.tsx                   â† ä¿®æ”¹ï¼šæ•´åˆç•™è¨€çµ±è¨ˆ
          settings/
            page.tsx                   â† ä¿®æ”¹ï¼šéš±ç§æ§åˆ¶
```

---

## Definition of Done

- [ ] æ‰€æœ‰ AC éƒ½å·²å¯¦ä½œ
- [ ] æ‰€æœ‰ Tasks éƒ½å·²å®Œæˆï¼ˆcheckbox æ¨™è¨˜ [x]ï¼‰
- [ ] TMI.js æˆåŠŸé€£æ¥ä¸¦ç›£è½è‡³å°‘ 1 å€‹é »é“
- [ ] è¨Šæ¯æ­£ç¢ºè§£æä¸¦å„²å­˜è‡³è³‡æ–™åº«
- [ ] èšåˆé‚è¼¯æ¯å°æ™‚åŸ·è¡Œï¼Œè³‡æ–™æ­£ç¢º
- [ ] API çµ±è¨ˆæŸ¥è©¢æ€§èƒ½ < 100msï¼ˆp95ï¼‰
- [ ] å‰ç«¯åœ–è¡¨æ­£ç¢ºé¡¯ç¤ºç•™è¨€è¶¨å‹¢èˆ‡äº’å‹•ç´°åˆ†
- [ ] éš±ç§æ§åˆ¶åŠŸèƒ½å¯æ­£å¸¸æ¸…é™¤è³‡æ–™
- [ ] å¾Œç«¯å–®å…ƒæ¸¬è©¦é€šéç‡ 100%
- [ ] å‰ç«¯çµ„ä»¶æ¸¬è©¦é€šéç‡ 100%
- [ ] E2E æ¸¬è©¦æ¶µè“‹å®Œæ•´äº’å‹•çµ±è¨ˆæµç¨‹
- [ ] ç„¡ ESLint éŒ¯èª¤
- [ ] ç„¡ TypeScript é¡å‹éŒ¯èª¤
- [ ] API æ–‡ä»¶å·²æ›´æ–°ï¼ˆOpenAPI/Swaggerï¼‰
- [ ] ç¨‹å¼ç¢¼å·²æäº¤è‡³ gitï¼ŒPR å·²é€šéå¯©æŸ¥
- [ ] æ•ˆèƒ½æ¸¬è©¦é€šéï¼ˆ100 é »é“ç›£è½ç©©å®šé‹è¡Œï¼‰
- [ ] ç›£æ§ç³»çµ±å¯é¡¯ç¤º TMI.js å¯¦ä¾‹ç‹€æ…‹

