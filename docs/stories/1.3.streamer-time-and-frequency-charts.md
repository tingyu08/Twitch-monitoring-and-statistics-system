# Story 1.3: streamer-time-and-frequency-charts

## Status

- Ready for Review (重構完成 - 2025-12-09)
- InProgress (Dev Agent 開始實作 - 2025-12-09)

## Related Documents

- `docs/prd.md#4-範圍與功能按-epic--story-組織` – Story 1.3 原始需求背景（開台時間與頻率圖表）  
- `docs/epic-1-streamer-analytics-dashboard.md#story-13--開台時間與頻率圖表` – Epic 1 整體目標與 Story 1.3 重點  
- `docs/architecture/fullstack-architecture.md#4-資料模型設計data-model` – `ChannelDailyStat` 時間序列資料模型與統計查詢設計  
- `docs/architecture/front-end-architecture.md#3-專案結構設計project-structure` – `streamer-dashboard/charts` 圖表封裝位置、圖表庫選擇（Recharts / ECharts）與響應式佈局策略

## Story

**As a** Twitch 實況主（Streamer）  
**I want** 以圖表方式查看開台時間分布與頻率（按日/週/時段）  
**so that** 我能根據長期趨勢調整開台時段與頻率以優化表現。

## Acceptance Criteria

1. **每日 / 每週開台時數圖表**
   - Given 實況主已登入並在儀表板選定時間區間  
   - When 實況主查看「開台時間趨勢」圖表  
   - Then 系統顯示一張折線或柱狀圖，x 軸為日期或週別，y 軸為該日/週總開台時數，並與 Summary Cards 數字一致。  

2. **一週內各時段開台頻率（Heatmap 或等效視覺）**
   - Given 已存在足夠的開台紀錄  
   - When 實況主查看「開台時段分布」視圖  
   - Then 系統顯示一張 Heatmap 或簡化分布圖：
     - 橫軸：星期（一～日）  
     - 縱軸：一天中的時段（例如每小時或區間）  
     - 色階或強度代表各欄位的開台時數或場數  

3. **圖表互動與可讀性**
   - Given 圖表已載入  
   - When 實況主在桌機上 hover，或在手機上點選圖表區域  
   - Then Tooltip 應顯示對應的日期 / 時段與數值，並標示單位（小時 / 場）；圖例/標題清楚說明圖表意義。  

4. **響應式佈局與行動裝置支援**
   - Given 實況主使用不同裝置（桌機 / 手機）查看儀表板  
   - When 畫面在 mobile、tablet、desktop 間切換  
   - Then 圖表應依 `front-end-spec.md` 的響應式策略調整：
     - Mobile：單欄顯示，各圖表上下堆疊，保留核心資訊  
     - Desktop：可兩欄並排顯示兩張圖表  

5. **資料不完整 / 無資料的視覺處理**
   - Given 選定期間資料不足或尚未累積  
   - When 圖表沒有可以顯示的點  
   - Then 應顯示 EmptyState 與簡短說明，而非空白或錯誤；若因 Twitch API 限制導致資料片段化，需顯示 Info Banner。  

## Tasks / Subtasks

- [x] Task 1（AC: 1）後端時間序列 API
  - [x] 在後端實作 `GET /api/streamer/me/time-series?range=...&granularity=day|week` 端點
  - [x] 依 `ChannelDailyStat` 等資料表計算每日/每週總開台時數與場數
  - [x] 回傳結構需附上日期（或週起始日）、總時數、場數等欄位

- [x] Task 2（AC: 2）後端 Heatmap / 時段分布資料
  - [x] 設計並實作 `GET /api/streamer/me/heatmap?range=...` 等端點
  - [x] 將一週 × 24 小時或區間的開台資訊彙整為矩陣資料結構
  - [x] 確保輸出中包含星期、時段、值，以及必要的最大/最小參考值供前端畫色階

- [x] Task 3（AC: 1, 2, 3）前端圖表元件實作
  - [x] 在 `streamer-dashboard` feature 下建立 `TimeSeriesChart` 與 `HeatmapChart` 封裝
  - [x] 使用選定的圖表庫（Recharts / ECharts）依 `front-end-architecture.md` 規劃實作
  - [x] 實作 Tooltip、Legend、X/Y 軸標籤與單位

- [x] Task 4（AC: 3, 4）互動與響應式
  - [x] 依 `front-end-spec.md` 的 breakpoints 對圖表容器進行佈局調整
  - [x] 確保 hover / focus 狀態符合 UX 文件的 motion 與可訪問性要求
  - [x] 行動裝置上以垂直堆疊顯示,保留 Tooltip 與最關鍵數據

- [x] Task 5（AC: 5）邊界情境與錯誤顯示
  - [x] 後端在資料不足時回傳明確狀態（空集合、旗標），避免 500 錯誤
  - [x] 前端偵測空資料時顯示 EmptyState 與簡短文字說明
  - [x] 若為 API 限制 / 資料延遲等 case，顯示 Info Banner（沿用共用 `Banner` 元件）

## Dev Notes

- 此 Story 與 Story 1.2 共用許多資料來源，請優先在後端實作清晰的查詢 API，避免前端重複彙總。  
- 資料模型與 API 設計請依 `docs/architecture/fullstack-architecture.md#4-資料模型設計data-model` 中的 `ChannelDailyStat` 時間序列資料模型與統計查詢設計實作。  
- 前端需沿用 `docs/architecture/front-end-architecture.md#3-專案結構設計project-structure` 所描述的 feature-based 結構，以 `streamer-dashboard/charts` 為主要圖表封裝位置。  
- **效能考量**：在一般資料量下（例如 90 天內每日一筆），圖表 render 不應造成明顯卡頓。建議實作時加入簡單的渲染時間觀察，必要時可考慮資料分頁或虛擬化。  

### Testing

**測試層級建議：**
- **後端**：時間序列與 Heatmap 資料查詢以 **Unit / Integration** 測試為主，驗證不同 granularity（day/week）與時間區間的資料正確性。  
- **前端**：Component 測試圖表元件（`TimeSeriesChart`、`HeatmapChart`）的渲染、Tooltip 互動與響應式佈局。  
- **端對端**：至少 1 條 **E2E** 路徑驗證完整流程（登入 → 選擇區間 → 查看圖表 → hover/點擊互動）。

**測試情境：**
- 驗證日/週時間序列圖：  
  - 當有既定測試數據時，前端圖表數值與 Summary Cards / DB 資料一致。  
- 驗證 Heatmap 正確性：  
  - 特定測試帳號在已知時段開台，Heatmap 對應格子有明顯高亮。  
- 驗證 hover / tooltip：  
  - 在不同裝置下 tooltip 顯示正確的時間與數值，並有單位。  
- 驗證無資料與錯誤情境：  
  - 沒有任何開台紀錄時，圖表顯示 EmptyState，不出現 console error。  

## Change Log

| Date       | Version | Description                                 | Author |
| ---------- | ------- | ------------------------------------------- | ------ |
| YYYY-MM-DD | 0.1     | 建立 Story 初稿：開台時間與頻率圖表需求定義 | PO     |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (Dev Agent - James)

### Debug Log References

_由 Dev Agent 於實作時填寫_

### Completion Notes List

**2025-12-09 - 重構完成**
- ✅ 抽取 Chart Loading UI 為共用元件 (`ChartStates.tsx`)
  - ChartLoading: 統一的載入動畫
  - ChartError: 錯誤顯示與重試按鈕
  - ChartEmpty: 空狀態顯示與友善提示
- ✅ 導入 SWR 進行資料獲取管理
  - 安裝 `swr` 套件
  - 建立 `useChartData.ts` hooks
  - 自動快取、重新驗證、錯誤處理
  - 30秒去重,避免重複請求
- ✅ 建立 Logger 工具統一日誌管理
  - 建立 `lib/logger.ts`
  - 生產環境自動禁用 debug logs
  - 提供專用 logger: apiLogger, authLogger, chartLogger
- ✅ 移除所有 debug console.log,改用 logger
  - httpClient 使用 apiLogger
  - AuthContext 使用 authLogger
  - StreamSummaryCards 使用 apiLogger
  - Dashboard page 使用 authLogger
- ✅ 重構 Dashboard Page
  - 移除手動 useEffect 資料獲取邏輯
  - 使用 SWR hooks (`useTimeSeriesData`, `useHeatmapData`)
  - 大幅簡化程式碼 (移除 ~30 行狀態管理邏輯)
  - 更好的錯誤處理與重試機制

**改善項目:**
- 程式碼可維護性提升 (共用元件、統一 API)
- 效能優化 (SWR 快取與去重)
- 開發體驗改善 (Logger 工具)
- 生產環境日誌清理

### File List

**新增檔案:**
- `frontend/src/lib/logger.ts` - Logger 工具
- `frontend/src/features/streamer-dashboard/charts/ChartStates.tsx` - Chart UI 元件
- `frontend/src/features/streamer-dashboard/hooks/useChartData.ts` - SWR hooks

**修改檔案:**
- `frontend/package.json` - 新增 swr 依賴
- `frontend/src/app/dashboard/streamer/page.tsx` - 重構使用 SWR 和新元件
- `frontend/src/features/streamer-dashboard/charts/index.ts` - 新增 exports
- `frontend/src/lib/api/httpClient.ts` - 使用 apiLogger
- `frontend/src/features/auth/AuthContext.tsx` - 使用 authLogger
- `frontend/src/features/streamer-dashboard/components/StreamSummaryCards.tsx` - 使用 apiLogger

**測試通過:**
- ✅ 編譯成功 (npm run build)
- ✅ 型別檢查通過
- ✅ 無 ESLint 錯誤

### File List

## QA Results

_由 QA Agent 於測試與審查後填寫_


