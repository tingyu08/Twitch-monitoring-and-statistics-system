schema: 1
story: "2.1"
story_title: "Viewer login and authorization"
gate: FAIL
status_reason: "Viewer consent flow loops (consent not present in auth session) and viewer detail page fails build due to React use() in client component."
reviewer: "Quinn (Test Architect)"
updated: "2025-12-12T00:00:00Z"

top_issues:
  - severity: high
    area: backend
    action: "Expose viewer consent state (consentedAt/consentVersion) in JWT or /api/auth/me to stop redirect loop after consent."
    refs:
      - backend/src/modules/auth/auth.routes.ts:20
      - backend/src/modules/auth/auth.service.ts:190
      - frontend/src/app/dashboard/viewer/page.tsx:29
    suggested_owner: dev
  - severity: high
    area: frontend
    action: "Replace React use() usage in client component and use standard params typing so viewer detail page can build."
    refs:
      - frontend/src/app/dashboard/viewer/[channelId]/page.tsx:1
    suggested_owner: dev
  - severity: medium
    area: backend
    action: "Add guard or default handling for VIEWER_TOKEN_ENCRYPTION_KEY to avoid OAuth crashes when key is missing; document requirement."
    refs:
      - backend/src/utils/crypto.utils.ts:8
      - backend/src/modules/auth/auth.service.ts:136
    suggested_owner: dev
  - severity: medium
    area: backend
    action: "Implement refresh token revocation on logout for Twitch tokens to align with AC6 expectations."
    refs:
      - backend/src/modules/auth/auth.routes.ts:38
    suggested_owner: dev

waiver: { active: false }
quality_score: 60
expires: "2025-12-26T00:00:00Z"

evidence:
  tests_reviewed: 0
  risks_identified: 4
  trace:
    ac_covered: [1, 3, 5]
    ac_gaps: [2, 4, 6]

nfr_validation:
  security:
    status: CONCERNS
    notes: "Encryption key hard-required; logout leaves Twitch tokens active."
  performance:
    status: PASS
    notes: "Mock data only; no perf regressions observed."
  reliability:
    status: FAIL
    notes: "Viewer consent loop and viewer detail page build failure block flow."
  maintainability:
    status: CONCERNS
    notes: "Viewer flow lacks automated tests; React hook misuse blocks build."

recommendations:
  immediate:
    - action: "Fix consent state propagation and rebuild viewer detail page with supported hooks."
      refs:
        - backend/src/modules/auth/auth.routes.ts:20
        - frontend/src/app/dashboard/viewer/[channelId]/page.tsx:1
  future:
    - action: "Add automated tests covering viewer OAuth, consent persistence, and logout revocation."
      refs:
        - backend/src/modules/auth/__tests__
