# Story 3.5: ç›£æ§èˆ‡ Log åŸºç¤

## Status

âœ… **Done** (éš±å«å®Œæˆæ–¼ Epic 1-2 é–‹ç™¼éç¨‹)

## Related Documents

- `docs/prd.md#4.3` â€“ Epic 3 åŸå§‹éœ€æ±‚
- `docs/epic-3-data-collection-and-platform-foundation.md` â€“ Epic 3 ç›®æ¨™èˆ‡ç¯„åœ

## Story

**ä½œç‚º** é‹ç¶­ / é–‹ç™¼äººå“¡
**æˆ‘æƒ³è¦** ç›£æ§ç³»çµ±éŒ¯èª¤èˆ‡é—œéµæŒ‡æ¨™
**ä»¥ä¾¿æ–¼** èƒ½åœ¨ç•°å¸¸æ™‚å¿«é€Ÿæ’æŸ¥å•é¡Œ

## Acceptance Criteria

1. **API è«‹æ±‚æ—¥èªŒ**

   - Given ç³»çµ±æ¥æ”¶ API è«‹æ±‚
   - When è«‹æ±‚è™•ç†å®Œæˆ
   - Then è¨˜éŒ„è«‹æ±‚æ–¹æ³•ã€è·¯å¾‘ã€ç‹€æ…‹ç¢¼èˆ‡å›æ‡‰æ™‚é–“

2. **éŒ¯èª¤æ—¥èªŒ**

   - Given ç³»çµ±ç™¼ç”ŸéŒ¯èª¤
   - When éŒ¯èª¤è¢«æ•ç²
   - Then è¨˜éŒ„è©³ç´°éŒ¯èª¤è³‡è¨Šï¼ˆå †ç–Šè¿½è¹¤ã€ä¸Šä¸‹æ–‡ï¼‰

3. **Job åŸ·è¡Œæ—¥èªŒ**

   - Given æ’ç¨‹ä»»å‹™åŸ·è¡Œ
   - When ä»»å‹™é–‹å§‹/å®Œæˆ/å¤±æ•—
   - Then è¨˜éŒ„åŸ·è¡Œç‹€æ…‹èˆ‡çµæœ

4. **å¥åº·æª¢æŸ¥ç«¯é»**

   - Given é‹ç¶­éœ€è¦ç›£æ§ç³»çµ±ç‹€æ…‹
   - When å‘¼å«å¥åº·æª¢æŸ¥ API
   - Then è¿”å›ç³»çµ±å„æœå‹™çš„å¥åº·ç‹€æ…‹

5. **æ•ˆèƒ½ç›£æ§**
   - Given éœ€è¦è¿½è¹¤ API æ•ˆèƒ½
   - When æŸ¥è©¢æ•ˆèƒ½æŒ‡æ¨™
   - Then è¿”å› P95/P99 å›æ‡‰æ™‚é–“ç­‰çµ±è¨ˆ

## Tasks / Subtasks

- [x] Task 1: å¯¦ä½œæ—¥èªŒç³»çµ±

  - [x] çµæ§‹åŒ–æ—¥èªŒå·¥å…·ï¼ˆ`logger.ts`ï¼‰
  - [x] ç’°å¢ƒæ„ŸçŸ¥æ—¥èªŒç´šåˆ¥
  - [x] æ§åˆ¶å°è¼¸å‡ºæ ¼å¼åŒ–

- [x] Task 2: å¯¦ä½œå¥åº·æª¢æŸ¥

  - [x] åŸºæœ¬å¥åº·æª¢æŸ¥ `/api/health`
  - [x] è©³ç´°å¥åº·æª¢æŸ¥ `/api/health/detailed`
  - [x] åˆ†æ•£å¼å¥åº·æª¢æŸ¥ `/api/health/distributed`

- [x] Task 3: å¯¦ä½œæ•ˆèƒ½ç›£æ§

  - [x] è«‹æ±‚è€—æ™‚è¿½è¹¤ä¸­é–“ä»¶
  - [x] API æ•ˆèƒ½çµ±è¨ˆ
  - [x] æ•ˆèƒ½å ±å‘Šç«¯é» `/api/admin/performance`

- [x] Task 4: å¯¦ä½œ Job æ—¥èªŒ
  - [x] Job é–‹å§‹/å®Œæˆæ—¥èªŒ
  - [x] éŒ¯èª¤è¨˜éŒ„èˆ‡å †ç–Šè¿½è¹¤
  - [x] åŸ·è¡Œçµæœçµ±è¨ˆ

## Dev Notes

### å·²å¯¦ä½œçš„ç›£æ§åŠŸèƒ½

**æ—¥èªŒç³»çµ±ï¼š**

```typescript
// backend/src/utils/logger.ts
export const logger = {
  info: (component: string, message: string, data?: unknown) => {...},
  warn: (component: string, message: string, data?: unknown) => {...},
  error: (component: string, message: string, error?: unknown) => {...},
  debug: (component: string, message: string, data?: unknown) => {...},
};
```

**å¥åº·æª¢æŸ¥ç«¯é»ï¼š**

- `GET /api/health` - åŸºæœ¬å¥åº·ç‹€æ…‹
- `GET /api/health/detailed` - è©³ç´°æœå‹™ç‹€æ…‹
- `GET /api/health/distributed` - åˆ†æ•£å¼ç³»çµ±ç‹€æ…‹

**æ•ˆèƒ½ç›£æ§ï¼š**

```typescript
// backend/src/utils/performance-monitor.ts
export const performanceMonitor = {
  middleware(): express.RequestHandler,
  getStats(): PerformanceStats,
  getEndpointStats(): EndpointStats[],
};
```

### é—œéµæª”æ¡ˆ

- `backend/src/utils/logger.ts` - æ—¥èªŒå·¥å…·
- `backend/src/utils/performance-monitor.ts` - æ•ˆèƒ½ç›£æ§
- `backend/src/modules/admin/health.routes.ts` - å¥åº·æª¢æŸ¥è·¯ç”±
- `backend/src/modules/admin/performance.routes.ts` - æ•ˆèƒ½ç›£æ§è·¯ç”±

### Job æ—¥èªŒç¯„ä¾‹

```
ğŸš€ [Jobs] æ­£åœ¨å•Ÿå‹•æ‰€æœ‰å®šæ™‚ä»»å‹™...
ğŸ“Š Channel Stats Sync Job å·²æ’ç¨‹: */15 * * * *
ğŸ“¡ Stream Status Job å·²æ’ç¨‹: */5 * * * *
âœ… [Jobs] æ‰€æœ‰å®šæ™‚ä»»å‹™å·²å•Ÿå‹•

ğŸ“¡ é–‹å§‹æª¢æŸ¥é–‹æ’­ç‹€æ…‹...
âœ… Stream Status Job å®Œæˆ: 5 é–‹æ’­, 10 é›¢ç·š, 2 æ–°å ´æ¬¡, 1 çµæŸå ´æ¬¡
```

## Definition of Done

- [x] æ—¥èªŒç³»çµ±æ­£å¸¸é‹ä½œ
- [x] å¥åº·æª¢æŸ¥ç«¯é»å¯ç”¨
- [x] æ•ˆèƒ½ç›£æ§æ”¶é›†çµ±è¨ˆ
- [x] Job åŸ·è¡Œæœ‰å®Œæ•´æ—¥èªŒ
- [x] éŒ¯èª¤è™•ç†æœ‰è©³ç´°è¨˜éŒ„

## Testing

- **æ¸¬è©¦ç«¯é»**ï¼š`GET /api/health`
- **æ¸¬è©¦æ¨™æº–**ï¼š
  - å¥åº·æª¢æŸ¥å›æ‡‰æ™‚é–“æ‡‰å°æ–¼ 200msã€‚
  - æ—¥èªŒè¼¸å‡ºçš„çµæ§‹æ‡‰ç¬¦åˆ JSON æ ¼å¼ï¼ˆç”Ÿç”¢ç’°å¢ƒï¼‰ã€‚
- **é—œéµæ¸¬è©¦å…§å®¹**ï¼š
  - **ç•°å¸¸æ•ç²**ï¼šæ‰‹å‹•æ‹‹å‡ºä¸€å€‹ 500 éŒ¯èª¤ï¼Œç¢ºèª `logger.error` æ˜¯å¦è¨˜éŒ„äº† Error Stackã€‚
  - **æ•ˆèƒ½æŒ‡æ¨™**ï¼šé©—è­‰ `performanceMonitor` æ˜¯å¦æ­£ç¢ºçµ±è¨ˆäº†ç‰¹å®š API çš„ `min/max/avg` å›æ‡‰æ™‚é–“ã€‚

## Change Log

| æ—¥æœŸ       | ç‰ˆæœ¬ | èªªæ˜              | ä½œè€… |
| ---------- | ---- | ----------------- | ---- |
| 2025-12-09 | 1.0  | å¯¦ä½œåŸºæœ¬æ—¥èªŒç³»çµ±  | Dev  |
| 2025-12-16 | 1.1  | æ–°å¢å¥åº·æª¢æŸ¥ç«¯é»  | Dev  |
| 2025-12-16 | 1.2  | æ–°å¢æ•ˆèƒ½ç›£æ§      | Dev  |
| 2025-12-18 | 1.3  | æ–°å¢ Job æ—¥èªŒç³»çµ± | Dev  |
| 2025-12-18 | 1.4  | è£œå»º Story æ–‡ä»¶   | SM   |

## é–‹ç™¼ä»£ç†äººç´€éŒ„

- **ä½¿ç”¨çš„ä»£ç†äººæ¨¡å‹**: `{{agent_model_name_version}}`
- **é™¤éŒ¯æ—¥èªŒå¼•ç”¨**: _ç„¡_
- **å®Œæˆç­†è¨˜åˆ—è¡¨**:
  - æˆåŠŸå¯¦ä½œçµæ§‹åŒ– logger æ¨¡çµ„ã€‚
  - æ•´åˆ `express` ä¸­é–“ä»¶é€²è¡Œè‡ªå‹•è€—æ™‚ç›£æ§ã€‚
- **æª”æ¡ˆåˆ—è¡¨**:
  - `backend/src/utils/logger.ts`
  - `backend/src/utils/performance-monitor.ts`
  - `backend/src/modules/admin/health.routes.ts`

## QA å¯©æŸ¥çµæœ

### æ¸¬è©¦è¦†è“‹ç‡

- **å–®å…ƒ/æ•´åˆæ¸¬è©¦**:
  - æ¸¬è©¦æª”æ¡ˆ: `backend/src/__tests__/integration/monitoring.test.ts`
  - ç¯„åœ: å¥åº·æª¢æŸ¥ç«¯é», æ•ˆèƒ½ä¸­é–“ä»¶ã€‚
  - ç‹€æ…‹: é‚è¼¯å·²é©—è­‰ã€‚
- **E2E æ¸¬è©¦**:
  - æ¸¬è©¦æª”æ¡ˆ: `e2e/tests/auth-flow.spec.ts`
  - ç¯„åœ: é€éç³»çµ±ç©©å®šæ€§æª¢æŸ¥éš±å«æ¶µè“‹ã€‚

### é©—è­‰ç‹€æ…‹

- âœ… **åŸºç¤è¨­æ–½**: 100% å°±ç·’ã€‚
- âœ… **åŸ·è¡Œç‹€æ…‹**: é€šé (æ‰‹å‹• cURL é©—è­‰å·²ç¢ºèª `/api/health` å›æ‡‰èˆ‡æ•ˆèƒ½æ—¥èªŒ)ã€‚
