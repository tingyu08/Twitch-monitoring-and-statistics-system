# Story 3.1: Twitch API 串接與授權管理

## Status

✅ **Done** (隱含完成於 Epic 1-2 開發過程)

## Related Documents

- `docs/prd.md#4.3` – Epic 3 原始需求
- `docs/epic-3-data-collection-and-platform-foundation.md` – Epic 3 目標與範圍
- `docs/architecture/fullstack-architecture.md` – 認證架構設計

## Story

**作為** 系統 **我想要** 透過官方 Twitch API 穩定取得實況主與觀眾所需的合法數據 **以便於**
儀表板能長期運作且符合法規與平台條款

## Acceptance Criteria

1. **OAuth 流程完整**
   - Given 使用者需要授權 Twitch 存取
   - When 使用者點擊登入按鈕
   - Then 系統完成 OAuth 2.0 授權流程並取得 access token

2. **Token 自動刷新**
   - Given 系統持有即將過期的 access token
   - When 執行 API 呼叫前檢測到 token 即將過期
   - Then 系統自動使用 refresh token 取得新的 access token

3. **Rate Limit 處理**
   - Given Twitch API 有呼叫頻率限制（800/min with App Token）
   - When 系統批次查詢 API
   - Then 系統遵守限制，必要時等待或降速

4. **多客戶端支援**
   - Given 系統需要同時使用 User Token 和 App Token
   - When 執行不同類型的 API 呼叫
   - Then 系統選擇適當的 Token 類型

## Tasks / Subtasks

- [x] Task 1: 實作 Twitch OAuth 2.0 登入流程
  - [x] 後端 OAuth controller 與 routes
  - [x] 前端登入按鈕與回調處理
  - [x] Token 安全儲存（httpOnly Cookie）

- [x] Task 2: 實作 Token 管理服務
  - [x] Twurple Auth Provider 整合
  - [x] App Access Token 自動刷新
  - [x] User Access Token 管理

- [x] Task 3: 實作 Helix API 客戶端
  - [x] Twurple API Client 封裝
  - [x] 使用者資訊查詢
  - [x] 頻道資訊查詢
  - [x] 直播狀態查詢

- [x] Task 4: Rate Limit 處理
  - [x] Twurple 內建 rate limit 處理
  - [x] 批次查詢優化（每批最多 100 個）

## Dev Notes

### 已實作的關鍵檔案

**認證模組：**

- `backend/src/modules/auth/auth.controller.ts` - OAuth 登入控制器
- `backend/src/modules/auth/auth.service.ts` - 認證服務
- `backend/src/modules/auth/auth.routes.ts` - 認證路由
- `backend/src/modules/auth/jwt.utils.ts` - JWT 工具

**Twitch 整合：**

- `backend/src/services/twurple-auth.service.ts` - Twurple 認證服務
- `backend/src/services/twitch-helix.service.ts` - Helix API 客戶端
- `backend/src/services/unified-twitch.service.ts` - 統一 Twitch 服務

### 技術決策

- **使用 Twurple 庫**：官方維護的 TypeScript Twitch API 封裝
- **App Access Token**：用於不需要用戶授權的 API（頻道狀態查詢）
- **User Access Token**：用於需要用戶授權的 API（個人資料）

## Definition of Done

- [x] OAuth 2.0 登入流程正常運作
- [x] Token 自動刷新機制實作
- [x] Helix API 可正常呼叫
- [x] Rate Limit 處理機制就緒
- [x] 整合測試通過

## Testing

- **測試標準**：所有 API 呼叫必須 Mock Twitch API 以避免消耗真實 Quota。
- **測試檔案位置**：`backend/src/services/__tests__/unified-twitch.service.test.ts`
- **關鍵測試場景**：
  - **Token 刷新**：模擬 401 錯誤，驗證 `refreshAccessToken` 是否被呼叫並重試請求。
  - **Rate Limit**：驗證當達到限制時，請求是否被緩衝或進行延遲處理。
  - **多類型 Token**：驗證 App Token 請求與 User Token 請求是否使用了正確的 Auth Provider。

## Change Log

| 日期       | 版本 | 說明                      | 作者 |
| ---------- | ---- | ------------------------- | ---- |
| 2025-12-09 | 1.0  | 隨 Story 1.1 完成基礎實作 | Dev  |
| 2025-12-16 | 1.1  | 整合 Twurple 服務         | Dev  |
| 2025-12-18 | 1.2  | 補建 Story 文件           | SM   |

## 開發代理人紀錄

- **使用的代理人模型**: `{{agent_model_name_version}}`
- **除錯日誌引用**: _無_
- **完成筆記列表**:
  - 整合 Twurple `RefreshingAuthProvider` 處理自動刷新。
  - 封裝 `TwitchHelixService` 提供統一查詢介面。
- **檔案列表**:
  - `backend/src/services/twurple-auth.service.ts`
  - `backend/src/services/twitch-helix.service.ts`

## QA 審查結果

### 測試覆蓋率

- **單元/整合測試**:
  - 測試檔案: `backend/src/services/__tests__/unified-twitch.service.test.ts`
  - 範圍: `getChannelInfo`, `getStreamsByUserIds` (Mock 資料).
  - 狀態: 邏輯已實作。已修正 Jest ESM 配置。
- **E2E 測試**:
  - 測試檔案: `e2e/tests/auth-flow.spec.ts`
  - 範圍: 使用者登入流程、Token 注入、儀表板存取。
  - 狀態: 通過 (已修正 Jest ESM 配置且 E2E 測試已穩定)。

### 驗證狀態

- ✅ **基礎設施**: 100% 就緒 (Jest + Playwright 已配置)。
- ✅ **執行狀態**: 通過 (已修正 Jest ESM 配置且 E2E 測試已穩定)。

### 品質門檻狀態

品質門檻: **PASS** → [3.1-twitch-api-integration.yml](../qa/gates/3.1-twitch-api-integration.yml)
風險評估: [3.1-risk-20251218.md](../qa/assessments/3.1-risk-20251218.md) 非功能性需求評估:
[3.1-nfr-20251218.md](../qa/assessments/3.1-nfr-20251218.md)

**審查結論：**
功能實作完整且安全性高。已修正後端 Jest 的 ESM 配置問題，並優化了 E2E 測試的穩定性（包含 Cookie 清除、網路狀態等待與選擇器強化）。目前系統已具備可靠的自動化驗證能力。

### 建議狀態

- [✓ 可以完工 (Ready for Done)] (手動與自動化驗證均通過)
