# Story 3.6: 使用者追蹤頻道與全域監控

## Status

✅ **Completed** (2025-12-19)

## Related Documents

- `docs/epic-3-data-collection-and-platform-foundation.md` – Epic 3 目標
- `docs/stories/3.3.scheduled-data-fetching.md` – 基礎排程機制
- `docs/stories/3.2.data-models.md` – 現有資料模型規範

## Story

**As a** 已註冊用戶 (Streamer/Viewer)
**I want** 系統能持續監控我追蹤的所有頻道的開台狀態
**So that** 即使那些頻道沒有註冊本平台，我仍能查看它們的歷史開台紀錄與統計

## Acceptance Criteria

1. **追蹤名單同步**

   - Given 用戶已透過 Twitch OAuth 授權 `user:read:follows` 權限
   - When 系統執行同步排程 (每天一次或手動觸發)
   - Then 將 Twitch 追蹤名單與本地資料庫同步，標記為 `isExternal: true` 如果該頻道尚未註冊平台

2. **外部頻道監控**

   - Given 資料庫中存在標記為監控中的頻道
   - When `Stream Status Job` 執行時
   - Then 系統應同時檢查「平台用戶頻道」與「用戶追蹤的外部頻道」

3. **重複追蹤處理**

   - Given 多個用戶追蹤同一個特定的外部頻道
   - When 執行監控任務時
   - Then 系統應對頻道 ID 進行去重 (De-duplication)，確保每個頻道每輪僅被查詢一次

4. **解除追蹤邏輯**

   - Given 用戶在 Twitch 上取消追蹤某頻道
   - When 同步排程執行後
   - Then 若該外部頻道不再被本系統任何用戶追蹤，則將其監控狀態設為 `inactive`，停止排程查詢

5. **大量頻道與 Rate Limit**
   - Given 監控頻道數量達到數千個
   - When 執行狀態查詢
   - Then 應使用 Twurple 的 Batch Get Streams (100/req)，並實作並發限制 (Concurrency Limit) 以保護 API Quota

## Tasks / Subtasks

- [x] **Task 1: 資料庫模型擴充**

  - [x] 修改 `Channel` 模型：新增 `isMonitored` (boolean) 與 `source` ('platform' | 'external') 欄位
  - [x] 建立 `UserFollow` 關聯表 (userId, channelId, userType, followedAt) 建立唯一索引
  - [x] 執行資料庫遷移腳本 (`npx prisma db push`)

- [x] **Task 2: 實作追蹤名單同步 Job**

  - [x] 建立 `sync-user-follows.job.ts`
  - [x] 整合 Twurple `apiClient.channels.getFollowedChannelsPaginated` 分頁抓取
  - [x] 實作差異同步邏輯 (Upsert 頻道，管理 UserFollow 關聯)

- [x] **Task 3: 升級 Stream Status Job**

  - [x] 修改 `getActiveChannels` 邏輯，查詢範圍改為 `isMonitored: true`
  - [x] 確保 Batching 邏輯處理 100 個 ID 的上限

- [x] **Task 4: 下線機制 (Cleanup Job)**
  - [x] 實作垃圾回收邏輯：`cleanupUnfollowedChannels()` 標記無人追蹤的外部頻道為 inactive

## Dev Notes

### 技術架構建議

- **去重查詢**：在 `StreamStatusJob` 中，先從資料庫拉取所有 `isMonitored = true` 的頻道 ID，轉為 `Set` 後再進行分段 (Chunking) 查詢。
- **並發控制**：使用 `p-limit` 或類似工具，限制同時進行的 Twitch API 請求數量 (建議上限 5-10 clusters)，避免瞬時壓力。
- **資料儲存**：外部頻道不需建立 `StreamChatLog`，僅儲存 `StreamSession` 與 `ChannelDailyStat` 以節省空間。

## Testing

- **測試檔案位置**：`backend/src/__tests__/integration/follows-sync.test.ts`
- **關鍵測試場景**：
  - 驗證同步時，新追蹤的頻道被正確加入並標記為 `external`。
  - 驗證多用戶追蹤同一頻道時，排程僅執行一次查詢。
  - 驗證取消追蹤後，最後一名關注者消失時，該頻道被標記為 `inactive`。
- **效能測試**：模擬 1000 個頻道的 Batching 處理時間。

## Change Log

| Date       | Version | Description                    | Author |
| ---------- | ------- | ------------------------------ | ------ |
| 2025-12-18 | 1.0     | 初始提案                       | Dev    |
| 2025-12-18 | 1.1     | 根據 SM 規範強化細節與邊際邏輯 | SM     |
| 2025-12-19 | 2.0     | 完成實作                       | Dev    |

## Dev Agent Record

- **Agent Model Used**: Claude / GPT-4
- **Debug Log References**: _N/A_
- **Completion Notes List**:
  - 擴充 Prisma Schema 新增 `isMonitored`, `source` 欄位與 `UserFollow` 模型
  - 實作 `getFollowedChannels` 方法於 `twitch-helix.service.ts`
  - 建立完整的 `sync-user-follows.job.ts` 包含同步與清理邏輯
  - 升級 `stream-status.job.ts` 支援 `isMonitored` 過濾
- **File List**:
  - `backend/prisma/schema.prisma`
  - `backend/src/services/twitch-helix.service.ts`
  - `backend/src/jobs/sync-user-follows.job.ts`
  - `backend/src/jobs/stream-status.job.ts`
  - `backend/src/jobs/index.ts`

## QA Results

- **Verification Status**: ✅ **Passed** (TypeScript 編譯通過，所有現有測試通過)
