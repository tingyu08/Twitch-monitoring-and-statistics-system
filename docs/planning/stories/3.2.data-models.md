# Story 3.2: 開台紀錄與互動統計資料模型

## Status

✅ **Done** (隱含完成於 Epic 1-2 開發過程)

## Related Documents

- `docs/prd.md#4.3` – Epic 3 原始需求
- `docs/epic-3-data-collection-and-platform-foundation.md` – Epic 3 目標與範圍
- `docs/architecture/fullstack-architecture.md` – 資料庫架構設計

## Story

**作為** 系統 **我想要** 有合理的資料表設計儲存開台與互動統計 **以便於**
能支援時間區間查詢與長期趨勢分析

## Acceptance Criteria

1. **實況主資料模型**
   - Given 實況主完成 OAuth 登入
   - When 系統建立實況主記錄
   - Then 資料庫儲存 Streamer 與關聯的 Channel 資料

2. **觀眾資料模型**
   - Given 觀眾完成 OAuth 登入並同意授權
   - When 系統建立觀眾記錄
   - Then 資料庫儲存 Viewer 與隱私同意資料

3. **開台記錄模型**
   - Given 實況主開始直播
   - When 系統偵測到開播事件
   - Then 建立 StreamSession 記錄追蹤直播資訊

4. **每日統計彙總**
   - Given 系統需要支援時間區間查詢
   - When 執行每日統計聚合任務
   - Then 產生 DailyStat 記錄供快速查詢

5. **觀眾互動統計**
   - Given 觀眾在頻道中產生互動（留言、訂閱等）
   - When 系統記錄互動事件
   - Then 彙總至 ViewerChannelDailyStat 表

## Tasks / Subtasks

- [x] Task 1: 設計核心資料模型
  - [x] Streamer 模型（實況主）
  - [x] Viewer 模型（觀眾）
  - [x] Channel 模型（頻道）
  - [x] TwitchToken 模型（Token 管理）

- [x] Task 2: 設計開台記錄模型
  - [x] StreamSession 模型
  - [x] ChannelDailyStat 模型

- [x] Task 3: 設計觀眾互動模型
  - [x] ViewerChannelDailyStat 模型
  - [x] ViewerChannelMessage 模型
  - [x] ViewerChannelMessageDailyAgg 模型

- [x] Task 4: 設計進階統計模型 (Story 2.4)
  - [x] ViewerChannelLifetimeStats 模型
  - [x] ViewerDashboardLayout 模型

- [x] Task 5: 設計隱私控制模型 (Story 2.5)
  - [x] ViewerPrivacyConsent 模型
  - [x] DeletionRequest 模型
  - [x] ExportJob 模型
  - [x] PrivacyAuditLog 模型

## Dev Notes

### Prisma Schema 模型清單 (17+ 個)

**核心模型：**

1. `Streamer` - 實況主基本資料
2. `Viewer` - 觀眾基本資料
3. `Channel` - Twitch 頻道
4. `TwitchToken` - OAuth Token 管理

**開台與統計：** 5. `StreamSession` - 直播場次記錄 6. `ChannelDailyStat` - 頻道每日統計

**觀眾互動：** 7. `ViewerChannelDailyStat` - 觀眾每日觀看統計 8.
`ViewerChannelMessage` - 觀眾留言記錄 9. `ViewerChannelMessageDailyAgg` - 留言每日彙總

**進階統計：** 10. `ViewerChannelLifetimeStats` - 觀眾全時段統計 11.
`ViewerDashboardLayout` - 儀表板佈局設定

**分散式協調：** 12. `ListenerInstance` - 聊天監聽實例 13. `ChannelListenerLock` - 頻道監聽鎖

**隱私控制：** 14. `ViewerPrivacyConsent` - 隱私同意設定 15. `DeletionRequest` - 刪除請求 16.
`ExportJob` - 資料匯出任務 17. `DataRetentionLog` - 資料保留日誌 18.
`PrivacyAuditLog` - 隱私操作審計

### 設計原則

1. **彙總優先**：儘量儲存彙總統計而非原始資料
2. **軟刪除**：支援匿名化而非完全刪除
3. **關聯完整**：使用 Prisma relations 確保資料一致性
4. **索引優化**：為常用查詢建立複合索引

## Definition of Done

- [x] 所有核心模型已定義
- [x] 資料庫 migration 成功執行
- [x] 關聯關係正確設定
- [x] 索引優化已配置
- [x] CRUD 操作驗證通過

## Testing

- **測試框架**：Prisma Studio / Jest
- **測試標準**：所有 Schema 變更必須通過 `npx prisma validate`。
- **關鍵測試內容**：
  - **關聯完整性**：驗證刪除實況主時，關聯的 `Channel` 處理符合預期（如級聯刪除或設定為 null）。
  - **資料型別驗證**：確保時間戳欄位（`createdAt`, `updatedAt`）自動更新。
  - **複合索引**：驗證按 `channelId` 與 `date` 查詢 `ChannelDailyStat` 的效能。

## Change Log

| 日期       | 版本 | 說明                            | 作者 |
| ---------- | ---- | ------------------------------- | ---- |
| 2025-12-09 | 1.0  | 建立核心模型（Streamer/Viewer） | Dev  |
| 2025-12-12 | 1.1  | 新增觀眾互動相關模型            | Dev  |
| 2025-12-16 | 1.2  | 新增聊天統計相關模型            | Dev  |
| 2025-12-17 | 1.3  | 新增隱私控制相關模型            | Dev  |
| 2025-12-18 | 1.4  | 補建 Story 文件                 | SM   |

## 開發代理人紀錄

- **使用的代理人模型**: `{{agent_model_name_version}}`
- **除錯日誌引用**: _無_
- **完成筆記列表**:
  - Prisma Schema 完成 18 個核心模型定義。
  - 成功執行資料庫遷移至本地 PostgreSQL/SQLite。
- **檔案列表**:
  - `backend/prisma/schema.prisma`
  - `backend/prisma/migrations/`

## QA 審查結果

### 測試覆蓋率

- **單元/整合測試**:
  - 測試檔案: 無 (透過服務層進行隱含測試)
  - 範圍: Schema 驗證, 透過 Prisma Client 檢查關聯完整性。
  - 狀態: 已通過 `npx prisma validate` 與編譯驗證。
- **E2E 測試**:
  - 測試檔案: `e2e/tests/auth-flow.spec.ts`
  - 範圍: 前端存取與資料持久化驗證。
  - 狀態: 邏輯正確。

### 驗證狀態

- ✅ **基礎設施**: 100% 就緒 (Prisma Client 已生成)。
- ✅ **執行狀態**: 通過 (Schema 驗證與遷移成功)。
